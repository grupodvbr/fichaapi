<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>CMV ‚Ä¢ Fichas T√©cnicas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* =========================================================
   VARI√ÅVEIS
========================================================= */
:root{
  --primary:#2563eb;
  --primary-dark:#1e40af;
  --success:#16a34a;
  --danger:#dc2626;
  --warning:#f59e0b;

  --bg:#f8fafc;
  --card:#ffffff;
  --text:#0f172a;
  --muted:#64748b;
  --border:#e5e7eb;

  --radius-lg:26px;
  --radius-md:14px;
  --radius-sm:8px;

  --shadow-sm:0 6px 16px rgba(0,0,0,.08);
  --shadow-md:0 18px 40px rgba(0,0,0,.12);
  --shadow-lg:0 40px 90px rgba(0,0,0,.35);
}

/* =========================================================
   RESET / BASE
========================================================= */
*{
  box-sizing:border-box;
  -webkit-font-smoothing:antialiased;
}

body{
  margin:0;
  font-family:Inter,sans-serif;
  background:var(--bg);
  color:var(--text);
}

/* =========================================================
   GRID PRINCIPAL
========================================================= */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(340px,1fr));
  gap:22px;
  padding:22px;
}

/* =========================================================
   CARD
========================================================= */
.card{
  background:var(--card);
  border-radius:22px;
  box-shadow:var(--shadow-md);
  overflow:hidden;
  cursor:pointer;
  transition:.18s ease;
}

.card:hover{
  transform:translateY(-4px);
  box-shadow:0 26px 60px rgba(0,0,0,.18);
}

.card img{
  width:100%;
  height:180px;
  object-fit:cover;
}

.card-body{
  padding:18px;
}

.card-body h3{
  margin:0 0 8px;
  font-weight:800;
}

/* =========================================================
   BADGES
========================================================= */
.badge{
  display:inline-block;
  padding:6px 12px;
  border-radius:999px;
  background:#eef2ff;
  color:#3730a3;
  font-size:12px;
  font-weight:800;
  margin:4px 6px 0 0;
}

/* =========================================================
   MODAL OVERLAY
========================================================= */
.modal{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,.65);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:100;
}

/* =========================================================
   MODAL BOX
========================================================= */
.modal-box{
  background:#fff;
  width:100%;
  max-width:880px;
  max-height:92vh;
  border-radius:var(--radius-lg);
  overflow:hidden;
  display:flex;
  flex-direction:column;
  box-shadow:var(--shadow-lg);
  animation:modalIn .25s ease;
}

@keyframes modalIn{
  from{transform:translateY(24px);opacity:0}
  to{transform:translateY(0);opacity:1}
}

/* =========================================================
   IMAGEM MODAL
========================================================= */
.modal-img{
  width:100%;
  height:240px;
  object-fit:cover;
  flex-shrink:0;
}

/* =========================================================
   CORPO MODAL
========================================================= */
.modal-body{
  padding:26px;
  overflow-y:auto;
}

.modal-body::-webkit-scrollbar{width:8px}
.modal-body::-webkit-scrollbar-thumb{
  background:#cbd5e1;
  border-radius:8px;
}

/* =========================================================
   BOT√ÉO FECHAR
========================================================= */
.close{
  position:absolute;
  top:14px;
  right:18px;
  font-size:26px;
  cursor:pointer;
  font-weight:900;
  color:#fff;
  z-index:10;
  text-shadow:0 2px 10px rgba(0,0,0,.6);
}

/* =========================================================
   TEXTOS
========================================================= */
.modal-body h2{
  margin:0 0 12px;
  font-size:26px;
  font-weight:900;
}

.modal-body h3{
  margin:20px 0 10px;
  font-size:16px;
  font-weight:900;
}

.modal-body p{
  margin:6px 0;
  font-size:14px;
  color:var(--muted);
}

.modal-body hr{
  border:none;
  height:1px;
  background:var(--border);
  margin:22px 0;
}

/* =========================================================
   LISTAS / INGREDIENTES / IMPOSTOS
========================================================= */
.ing{
  display:grid;
  grid-template-columns:1fr auto auto;
  gap:14px;
  padding:12px 0;
  border-bottom:1px dashed var(--border);
  font-size:14px;
  align-items:center;
}

.ing:last-child{border-bottom:none}

.ing b{font-weight:800}
.ing small{color:var(--muted)}

.lista-impostos .ing{
  grid-template-columns:1fr auto auto;
}

/* =========================================================
   PRECIFICA√á√ÉO (MARKUP)
========================================================= */
.precificacao{
  background:#f1f5f9;
  border:1px solid var(--border);
  border-radius:18px;
  padding:16px;
  margin:16px 0;
}

.precificacao input{
  height:44px;
  padding:0 14px;
  border-radius:12px;
  border:1px solid var(--border);
  font-size:14px;
  font-weight:700;
}

.precificacao input[readonly]{
  background:#e5e7eb;
  color:#334155;
}

/* =========================================================
   FORMUL√ÅRIOS
========================================================= */
input, select{
  font-family:Inter,sans-serif;
}

.form-impostos{
  display:grid;
  grid-template-columns:2fr 1fr 1fr 1fr;
  gap:10px;
  margin-top:12px;
}

.form-impostos input,
.form-impostos select{
  height:44px;
  border-radius:12px;
  border:1px solid var(--border);
  padding:0 14px;
  font-size:14px;
  font-weight:600;
}

.form-impostos input:focus,
.form-impostos select:focus{
  outline:none;
  border-color:var(--primary);
  box-shadow:0 0 0 3px rgba(37,99,235,.15);
}

/* =========================================================
   BOT√ïES
========================================================= */
button{
  font-family:Inter,sans-serif;
  border:none;
  cursor:pointer;
}

/* BOT√ÉO PRINCIPAL */
.btn-add{
  height:44px;
  padding:0 22px;
  border-radius:14px;
  background:linear-gradient(135deg,var(--primary),var(--primary-dark));
  color:#fff;
  font-size:13px;
  font-weight:900;
  letter-spacing:.05em;
  box-shadow:0 12px 30px rgba(37,99,235,.35);
  transition:.15s ease;
}

.btn-add:hover{
  transform:translateY(-1px);
  box-shadow:0 16px 40px rgba(37,99,235,.45);
}

/* BOT√ïES √çCONE */
.btn-icon{
  border-radius:10px;
  padding:6px 12px;
  font-size:14px;
  font-weight:800;
  transition:.12s ease;
}

.btn-edit{
  background:#e0f2fe;
  color:#0369a1;
}

.btn-edit:hover{background:#bae6fd}

.btn-delete{
  background:#fee2e2;
  color:#991b1b;
}

.btn-delete:hover{background:#fecaca}

/* =========================================================
   FILTROS
========================================================= */
.filters{
  display:flex;
  gap:14px;
  padding:22px 22px 0;
  flex-wrap:wrap;
}

.filters input,
.filters select{
  padding:14px 18px;
  border-radius:999px;
  border:1px solid var(--border);
  font-size:14px;
  font-weight:600;
}

/* =========================================================
   RESPONSIVO
========================================================= */
@media(max-width:900px){
  .modal-box{max-width:96%}
}

@media(max-width:700px){
  .lista-impostos .ing{
    grid-template-columns:1fr;
    gap:8px;
  }

  .form-impostos{
    grid-template-columns:1fr;
  }

  .btn-add{
    width:100%;
  }
}

@media(max-width:520px){
  .modal-img{height:200px}
}


</style>
</head>

<body>
<div class="filters">
  <input id="filtroNome" type="text" placeholder="Buscar por nome do prato">
  <select id="filtroTipo">
    <option value="">Todos os tipos</option>
    <option value="SUSHI">SUSHI</option>
    <option value="DRINK">DRINK</option>
    <option value="ENTRADA">ENTRADA</option>
    <option value="PRATO PRINCIPAL">PRATO PRINCIPAL</option>
    <option value="SOBREMESA">SOBREMESA</option>
    <option value="ACOMPANHAMENTO">ACOMPANHAMENTO</option>
  </select>
</div>

<div id="cards" class="grid"></div>

<!-- MODAL -->
<div id="modal" class="modal" onclick="fechar()">
  <div class="modal-box" onclick="event.stopPropagation()">
    <span class="close" onclick="fechar()">‚úï</span>
    <img id="mFoto" class="modal-img">
    <div id="mBody" class="modal-body"></div>
  </div>
</div>

<script>
/* ================= SUPABASE ================= */
const sb = supabase.createClient(
  "https://dxkszikemntfusfyrzos.supabase.co",
  "sb_publishable_NNFvdfSXgOdGGVcSbphbjQ_brC3_9ed"
);
let ingredientesBase = [];

async function carregarIngredientesBase(){
  const { data, error } = await sb
    .from("produtos") // üëà ajuste se o nome for outro
    .select("*")
    .order("nome");

  if(error){
    console.error(error);
    alert("Erro ao carregar ingredientes");
    return;
  }

  ingredientesBase = data;
}

const moeda = v =>
  "R$ " + Number(v || 0).toLocaleString("pt-BR",{minimumFractionDigits:2});

/* ================= STATE ================= */
let pratos = [];
let impostosCache = [];

/* ================= LOAD PRATOS ================= */
async function carregarPratos(){
  const { data, error } = await sb
    .from("buffet")
    .select("*")
    .order("created_at",{ascending:false});

  if(error){
    console.error(error);
    alert("Erro ao carregar pratos");
    return;
  }

  pratos = data;
  renderLista();
}

/* ================= FILTROS ================= */
function renderLista(){
  cards.innerHTML = "";

  const nomeFiltro = (filtroNome?.value || "").toUpperCase();
  const tipoFiltro = filtroTipo?.value || "";

  pratos
    .filter(p =>
      (!nomeFiltro || p.nome.toUpperCase().includes(nomeFiltro)) &&
      (!tipoFiltro || p.tipo === tipoFiltro)
    )
    .forEach(renderCard);
}

/* ================= CARD ================= */
function renderCard(p){
  const c = document.createElement("div");
  c.className = "card";
  c.onclick = ()=>abrir(p);

  c.innerHTML = `
    ${p.foto_url ? `<img src="${p.foto_url}">` : ``}
    <div class="card-body">
      <h3>${p.nome}</h3>
      <span class="badge">${p.tipo || "-"}</span>
      <span class="badge">CMV ${moeda(p.custo_unitario)}</span>
      ${Number(p.preco_venda) > 0 ? `<span class="badge">Venda ${moeda(p.preco_venda)}</span>` : ``}
    </div>
  `;
  cards.appendChild(c);
}

/* ================= MODAL ================= */
async function abrir(p){
  document.body.style.overflow = "hidden";
  modal.style.display = "flex";
  mFoto.src = p.foto_url || "";

  /* INGREDIENTES */
  const { data: itens } = await sb
    .from("buffet_itens")
    .select("*")
    .eq("buffet_id", p.id);

  const cmv = itens.reduce((s,i)=>s + Number(i.custo_calculado||0),0);

  /* IMPOSTOS / CUSTOS */
  const { data: impostos } = await sb
    .from("impostos")
    .select("*")
    .eq("buffet_id", p.id);

  impostosCache = impostos || [];

let totalImpostos = 0;

impostosCache.forEach(i => {
  const valor = Number(i.valor || 0);

  if (i.modalidade === "FIXO") {
    totalImpostos += valor;
  }

  if (i.modalidade === "PERCENTUAL") {
    totalImpostos += (cmv * valor) / 100;
  }
});

const cmvFinal = cmv + totalImpostos;

// ativa c√°lculo autom√°tico do markup
setTimeout(() => {
  const mkInput = document.getElementById("markupPerc");
  const precoInput = document.getElementById("precoSugerido");

  if(mkInput && precoInput){
    mkInput.oninput = () => {
      const mk = Number(mkInput.value || 0);
      const precoCalc = cmvFinal * (1 + mk / 100);
      precoInput.value = moeda(precoCalc);
    };
  }
}, 50);


  
  const precoVenda = Number(p.preco_venda||0);
  const lucro = precoVenda > 0 ? precoVenda - (cmv + totalImpostos) : 0;
const margem =
  precoVenda > 0 && lucro !== 0
    ? (lucro / precoVenda) * 100
    : 0;

  mBody.innerHTML = `
    <h2>${p.nome}</h2>

    ${precoVenda > 0 ? `<p><b>Pre√ßo de venda:</b> ${moeda(precoVenda)}</p>` : ``}
    <p><b>CMV:</b> ${moeda(cmv)}</p>
    <p><b>Impostos / Custos:</b> ${moeda(totalImpostos)}</p>
<hr>
<h3>Precifica√ß√£o (Markup)</h3>

<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;align-items:center">
  <input id="markupPerc"
         type="number"
         step="1"
         placeholder="Markup (%)">

  <input id="precoSugerido"
         readonly
         placeholder="Pre√ßo sugerido">
</div>

<button class="btn-add"
        style="margin-top:10px"
        onclick="salvarPrecoVenda('${p.id}')">
  SALVAR PRE√áO DE VENDA
</button>

    ${precoVenda > 0 ? `
      <p><b>Lucro:</b> ${moeda(lucro)}</p>
      <p><b>Margem:</b> ${margem.toFixed(2)}%</p>
    ` : `
      <p style="color:#dc2626;font-weight:700">
        ‚ö†Ô∏è Pre√ßo de venda n√£o cadastrado
      </p>
    `}

<hr>
<h3>Ingredientes</h3>

<div class="lista-ingredientes">
  ${itens.map(i=>`
    <div class="ing">
      <span>
        <b>${i.nome}</b><br>
        <small>${i.quantidade} ${i.unidade_uso}</small>
      </span>

      <strong>${moeda(i.custo_calculado)}</strong>

      <div style="display:flex;gap:6px">
        <button class="btn-icon btn-edit"
                onclick="editarIngrediente('${i.id}','${p.id}')">
          ‚úèÔ∏è
        </button>

        <button class="btn-icon btn-delete"
                onclick="excluirIngrediente('${i.id}','${p.id}')">
          üóëÔ∏è
        </button>
      </div>
    </div>
  `).join("")}
</div>

<div class="precificacao">
  <h3>Adicionar / Editar ingrediente</h3>

  <select id="ingProduto">
    <option value="">Selecione o ingrediente</option>
    ${ingredientesBase.map(p=>`
      <option value="${p.id}"
              data-custo="${p.custo_unitario}"
              data-unidade="${p.unidade_padrao}">
        ${p.nome}
      </option>
    `).join("")}
  </select>

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px">
    <input id="ingQtd" type="number" step="0.001" placeholder="Quantidade usada">
    <input id="ingUnidade" placeholder="Unidade" readonly>
  </div>

  <button id="btnIngrediente"
          class="btn-add"
          style="margin-top:12px"
          onclick="salvarIngrediente('${p.id}')">
    SALVAR INGREDIENTE
  </button>
</div>

            </div>
          `;
        }).join("")
  }
</div>


<div style="margin-top:12px;display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:8px">
  <input id="impDesc" placeholder="Descri√ß√£o">

  <select id="impTipo">
    <option value="IMPOSTO">IMPOSTO</option>
    <option value="CUSTO">CUSTO</option>
  </select>

  <select id="impModalidade">
    <option value="FIXO">VALOR FIXO</option>
    <option value="PERCENTUAL">PERCENTUAL (%)</option>
  </select>

  <input id="impValor" type="number" step="0.01" placeholder="Valor">
</div>

<button style="margin-top:12px" onclick="salvarImposto('${p.id}')">
  ADICIONAR
</button>

  `;
}
async function salvarImposto(buffetId){
  const desc = impDesc.value.trim();
  const tipo = impTipo.value;
  const modalidade = impModalidade.value;
  const valor = Number(impValor.value || 0);

  if(!desc || valor <= 0){
    alert("Preencha descri√ß√£o e valor");
    return;
  }

  const { error } = await sb
    .from("impostos")
    .insert({
      buffet_id: buffetId,
      descricao: desc,
      tipo,
      modalidade,
      valor
    });

  if(error){
    console.error("ERRO IMPOSTO:", error);
    alert(error.message);
    return;
  }

  // limpa campos
  impDesc.value = "";
  impValor.value = "";

  // recarrega modal
  abrir(pratos.find(p => p.id === buffetId));
}
async function excluirImposto(impostoId, buffetId){
  if(!confirm("Deseja excluir este custo/imposto?")) return;

  const { error } = await sb
    .from("impostos")
    .delete()
    .eq("id", impostoId);

  if(error){
    console.error(error);
    alert("Erro ao excluir");
    return;
  }

  abrir(pratos.find(p => p.id === buffetId));
}
async function editarImposto(impostoId, buffetId){
  const imposto = impostosCache.find(i => i.id === impostoId);
  if(!imposto) return;

  impDesc.value = imposto.descricao;
  impTipo.value = imposto.tipo;
  impModalidade.value = imposto.modalidade;
  impValor.value = imposto.valor;

  // muda bot√£o para salvar edi√ß√£o
  const btn = document.querySelector(".btn-add");
  btn.innerText = "SALVAR";
  btn.onclick = async () => {
    const desc = impDesc.value.trim();
    const tipo = impTipo.value;
    const modalidade = impModalidade.value;
    const valor = Number(impValor.value || 0);

    if(!desc || valor <= 0){
      alert("Preencha descri√ß√£o e valor");
      return;
    }

    const { error } = await sb
      .from("impostos")
      .update({
        descricao: desc,
        tipo,
        modalidade,
        valor
      })
      .eq("id", impostoId);

    if(error){
      console.error(error);
      alert("Erro ao atualizar");
      return;
    }

    // restaura bot√£o
    btn.innerText = "ADICIONAR";
    btn.onclick = () => salvarImposto(buffetId);

    impDesc.value = "";
    impValor.value = "";

    abrir(pratos.find(p => p.id === buffetId));
  };
}

/* ================= FECHAR ================= */
function fechar(){
  modal.style.display = "none";
  document.body.style.overflow = "";
}

/* ================= INIT ================= */
carregarPratos();
async function salvarPrecoVenda(buffetId){
  const mk = Number(markupPerc.value || 0);
  if(mk <= 0){
    alert("Informe o markup");
    return;
  }

  const prato = pratos.find(p => p.id === buffetId);

  // CMV FINAL = CMV base + impostos
  let cmvFinal = prato.custo_unitario;

  impostosCache.forEach(i => {
    if(i.modalidade === "FIXO"){
      cmvFinal += Number(i.valor);
    }
    if(i.modalidade === "PERCENTUAL"){
      cmvFinal += (prato.custo_unitario * Number(i.valor)) / 100;
    }
  });

  const precoVenda = cmvFinal * (1 + mk / 100);

  const { error } = await sb
    .from("buffet")
    .update({ preco_venda: precoVenda })
    .eq("id", buffetId);

  if(error){
    console.error(error);
    alert("Erro ao salvar pre√ßo");
    return;
  }

  abrir(prato);
}
let ingredientesBase = [];

async function carregarIngredientesBase(){
  const { data, error } = await sb
    .from("produtos") // üëà ajuste se o nome for outro
    .select("*")
    .order("nome");

  if(error){
    console.error(error);
    alert("Erro ao carregar ingredientes");
    return;
  }

  ingredientesBase = data;
}
/* ================= INGREDIENTES BASE ================= */
let ingredientesBase = [];

async function carregarIngredientesBase(){
  const { data, error } = await sb
    .from("produtos") // ajuste se necess√°rio
    .select("*")
    .order("nome");

  if(error){
    console.error(error);
    alert("Erro ao carregar ingredientes");
    return;
  }

  ingredientesBase = data;
}

carregarIngredientesBase();

/* ================= AUTO UNIDADE ================= */
document.addEventListener("change", e=>{
  if(e.target.id === "ingProduto"){
    const opt = e.target.selectedOptions[0];
    if(!opt) return;
    ingUnidade.value = opt.dataset.unidade || "";
  }
});

/* ================= SALVAR INGREDIENTE ================= */
async function salvarIngrediente(buffetId){
  const produtoId = ingProduto.value;
  const qtd = Number(ingQtd.value || 0);

  if(!produtoId || qtd <= 0){
    alert("Selecione o ingrediente e informe a quantidade");
    return;
  }

  const produto = ingredientesBase.find(p => p.id === produtoId);
  const custoUnit = Number(produto.custo_unitario);
  const custoCalc = custoUnit * qtd;

  const { error } = await sb
    .from("buffet_itens")
    .insert({
      buffet_id: buffetId,
      produto_id: produto.id,
      nome: produto.nome,
      quantidade: qtd,
      unidade_uso: produto.unidade_padrao,
      custo_unitario: custoUnit,
      custo_calculado: custoCalc
    });

  if(error){
    console.error(error);
    alert("Erro ao salvar ingrediente");
    return;
  }

  ingProduto.value = "";
  ingQtd.value = "";
  ingUnidade.value = "";

  abrir(pratos.find(p => p.id === buffetId));
}

/* ================= EDITAR INGREDIENTE ================= */
async function editarIngrediente(itemId, buffetId){
  const { data, error } = await sb
    .from("buffet_itens")
    .select("*")
    .eq("id", itemId)
    .single();

  if(error){
    console.error(error);
    return;
  }

  ingProduto.value = data.produto_id;
  ingQtd.value = data.quantidade;
  ingUnidade.value = data.unidade_uso;

  const btn = document.getElementById("btnIngrediente");
  btn.innerText = "ATUALIZAR INGREDIENTE";

  btn.onclick = async () => {
    const qtd = Number(ingQtd.value || 0);
    if(qtd <= 0){
      alert("Quantidade inv√°lida");
      return;
    }

    const produto = ingredientesBase.find(p => p.id === ingProduto.value);
    const custoCalc = produto.custo_unitario * qtd;

    const { error } = await sb
      .from("buffet_itens")
      .update({
        quantidade: qtd,
        custo_calculado: custoCalc
      })
      .eq("id", itemId);

    if(error){
      console.error(error);
      alert("Erro ao atualizar ingrediente");
      return;
    }

    btn.innerText = "SALVAR INGREDIENTE";
    btn.onclick = () => salvarIngrediente(buffetId);

    ingProduto.value = "";
    ingQtd.value = "";
    ingUnidade.value = "";

    abrir(pratos.find(p => p.id === buffetId));
  };
}

/* ================= EXCLUIR INGREDIENTE ================= */
async function excluirIngrediente(itemId, buffetId){
  if(!confirm("Excluir este ingrediente do prato?")) return;

  const { error } = await sb
    .from("buffet_itens")
    .delete()
    .eq("id", itemId);

  if(error){
    console.error(error);
    alert("Erro ao excluir ingrediente");
    return;
  }

  abrir(pratos.find(p => p.id === buffetId));
}

  
</script>


</body>
</html>
