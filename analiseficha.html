<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>CMV ‚Ä¢ Fichas T√©cnicas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* =========================================================
   VARI√ÅVEIS
========================================================= */
/* =========================================================
   VARI√ÅVEIS
========================================================= */
:root{
  --primary:#2563eb;
  --primary-dark:#1e40af;
  --success:#16a34a;
  --danger:#dc2626;
  --warning:#f59e0b;

  --bg:#f8fafc;
  --card:#ffffff;
  --text:#0f172a;
  --muted:#64748b;
  --border:#e5e7eb;

  --radius-lg:26px;
  --radius-md:14px;
  --radius-sm:8px;

  --shadow-sm:0 6px 16px rgba(0,0,0,.08);
  --shadow-md:0 18px 40px rgba(0,0,0,.12);
  --shadow-lg:0 40px 90px rgba(0,0,0,.35);
}

/* =========================================================
   RESET / BASE
========================================================= */
*{
  box-sizing:border-box;
  -webkit-font-smoothing:antialiased;
}

body{
  margin:0;
  font-family:Inter,sans-serif;
  background:var(--bg);
  color:var(--text);
}

/* trava scroll quando modal aberto */
body.modal-open{
  overflow:hidden;
  position:fixed;
  width:100%;
}

/* =========================================================
   FILTROS
========================================================= */
.filters{
  display:flex;
  gap:14px;
  padding:22px 22px 0;
  flex-wrap:wrap;
}

.filters input,
.filters select{
  padding:14px 18px;
  border-radius:999px;
  border:1px solid var(--border);
  font-size:14px;
  font-weight:600;
  width:100%;
  max-width:320px;
}

/* =========================================================
   GRID PRINCIPAL
========================================================= */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(340px,1fr));
  gap:22px;
  padding:22px;
}

/* =========================================================
   CARD
========================================================= */
.card{
  background:var(--card);
  border-radius:22px;
  box-shadow:var(--shadow-md);
  overflow:hidden;
  cursor:pointer;
  transition:.18s ease;
}

.card:hover{
  transform:translateY(-4px);
  box-shadow:0 26px 60px rgba(0,0,0,.18);
}

.card img{
  width:100%;
  height:180px;
  object-fit:cover;
}

.card-body{
  padding:18px;
}

.card-body h3{
  margin:0 0 8px;
  font-weight:800;
  font-size:16px;
}

/* =========================================================
   BADGES
========================================================= */
.badge{
  display:inline-block;
  padding:6px 12px;
  border-radius:999px;
  background:#eef2ff;
  color:#3730a3;
  font-size:12px;
  font-weight:800;
  margin:4px 6px 0 0;
}

/* =========================================================
   MODAL OVERLAY
========================================================= */
.modal{
  position:fixed;
  inset:0;
  background:rgba(15,23,42,.65);
  backdrop-filter:blur(6px);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:100;
}

/* =========================================================
   MODAL BOX (SEM BALAN√áAR)
========================================================= */
.modal-box{
  background:#fff;
  width:100%;
  max-width:880px;
  max-height:92vh;
  border-radius:26px;
  overflow:hidden;
  display:flex;
  flex-direction:column;
  box-shadow:var(--shadow-lg);
  animation:modalIn .2s ease;
}

/* anima√ß√£o est√°vel (SEM translate) */
@keyframes modalIn{
  from{
    opacity:0;
    transform:scale(0.96);
  }
  to{
    opacity:1;
    transform:scale(1);
  }
}

/* =========================================================
   IMAGEM MODAL
========================================================= */
.modal-img{
  width:100%;
  height:240px;
  object-fit:cover;
  flex-shrink:0;
}

/* =========================================================
   CORPO MODAL
========================================================= */
.modal-body{
  padding:26px;
  overflow-y:auto;
}

.modal-body::-webkit-scrollbar{
  width:8px;
}

.modal-body::-webkit-scrollbar-thumb{
  background:#cbd5e1;
  border-radius:8px;
}

/* =========================================================
   BOT√ÉO FECHAR
========================================================= */
.close{
  position:absolute;
  top:14px;
  right:18px;
  font-size:26px;
  cursor:pointer;
  font-weight:900;
  color:#fff;
  z-index:10;
  text-shadow:0 2px 10px rgba(0,0,0,.6);
}

/* =========================================================
   TEXTOS
========================================================= */
.modal-body h2{
  margin:0 0 12px;
  font-size:26px;
  font-weight:900;
}

.modal-body h3{
  margin:20px 0 10px;
  font-size:16px;
  font-weight:900;
}

.modal-body p{
  margin:6px 0;
  font-size:14px;
  color:var(--muted);
}

.modal-body hr{
  border:none;
  height:1px;
  background:var(--border);
  margin:22px 0;
}

/* =========================================================
   LISTAS / INGREDIENTES / IMPOSTOS
========================================================= */
.ing{
  display:grid;
  grid-template-columns:1fr auto auto;
  gap:14px;
  padding:12px 0;
  border-bottom:1px dashed var(--border);
  font-size:14px;
  align-items:center;
}

.ing:last-child{border-bottom:none}

.ing b{font-weight:800}
.ing small{color:var(--muted)}

/* =========================================================
   PRECIFICA√á√ÉO / FORMUL√ÅRIOS
========================================================= */
.precificacao{
  background:#f1f5f9;
  border:1px solid var(--border);
  border-radius:18px;
  padding:16px;
  margin:16px 0;
}

input, select{
  height:44px;
  border-radius:12px;
  border:1px solid var(--border);
  padding:0 14px;
  font-size:14px;
  font-weight:600;
  width:100%;
}

input:focus, select:focus{
  outline:none;
  border-color:var(--primary);
  box-shadow:0 0 0 3px rgba(37,99,235,.15);
}

input[readonly]{
  background:#e5e7eb;
}

/* =========================================================
   BOT√ïES
========================================================= */
button{
  font-family:Inter,sans-serif;
  border:none;
  cursor:pointer;
}

/* principal */
.btn-add{
  height:44px;
  padding:0 22px;
  border-radius:14px;
  background:linear-gradient(135deg,var(--primary),var(--primary-dark));
  color:#fff;
  font-size:13px;
  font-weight:900;
  letter-spacing:.05em;
  box-shadow:0 12px 30px rgba(37,99,235,.35);
  transition:.15s ease;
}

.btn-add:hover{
  transform:translateY(-1px);
  box-shadow:0 16px 40px rgba(37,99,235,.45);
}

/* √≠cones */
.btn-icon{
  border-radius:10px;
  padding:6px 12px;
  font-size:14px;
  font-weight:800;
}

.btn-edit{
  background:#e0f2fe;
  color:#0369a1;
}

.btn-delete{
  background:#fee2e2;
  color:#991b1b;
}

/* =========================================================
   MOBILE ‚Äî 3 CARDS POR LINHA + MODAL APP STYLE
========================================================= */
@media(max-width:520px){

  /* 3 cards por linha */
  .grid{
    grid-template-columns:repeat(3,1fr);
    gap:10px;
    padding:14px;
  }

  .card{
    border-radius:16px;
  }

  .card img{
    height:110px;
  }

  .card-body{
    padding:10px;
  }

  .card-body h3{
    font-size:13px;
    line-height:1.1;
  }

  .badge{
    font-size:10px;
    padding:4px 8px;
  }

  /* modal estilo app */
  .modal{
    align-items:flex-end;
  }

  .modal-box{
    max-width:100%;
    height:92vh;
    border-radius:22px 22px 0 0;
  }

  .modal-img{
    height:180px;
  }

  .modal-body{
    padding:18px;
  }

  .close{
    top:10px;
    right:14px;
    font-size:22px;
  }

  .ing{
    grid-template-columns:1fr auto;
    gap:8px;
  }

  .btn-add{
    width:100%;
  }
}


</style>
</head>

<body>
<div class="filters">
  <input id="filtroNome" type="text" placeholder="Buscar por nome do prato">
  <select id="filtroTipo">
    <option value="">Todos os tipos</option>
    <option value="SUSHI">SUSHI</option>
    <option value="DRINK">DRINK</option>
    <option value="ENTRADA">ENTRADA</option>
    <option value="PRATO PRINCIPAL">PRATO PRINCIPAL</option>
    <option value="SOBREMESA">SOBREMESA</option>
    <option value="ACOMPANHAMENTO">ACOMPANHAMENTO</option>
  </select>
</div>

<div id="cards" class="grid"></div>

<!-- MODAL -->
<div id="modal" class="modal" onclick="fechar()">
  <div class="modal-box" onclick="event.stopPropagation()">
    <span class="close" onclick="fechar()">‚úï</span>
    <img id="mFoto" class="modal-img">
    <div id="mBody" class="modal-body"></div>
  </div>
</div>

<script>
/* =====================================================
   SUPABASE
===================================================== */
const sb = supabase.createClient(
  "https://dxkszikemntfusfyrzos.supabase.co",
  "sb_publishable_NNFvdfSXgOdGGVcSbphbjQ_brC3_9ed"
);

/* =====================================================
   UTIL
===================================================== */
const moeda = v =>
  "R$ " + Number(v || 0).toLocaleString("pt-BR",{minimumFractionDigits:2});

/* =====================================================
   STATE
===================================================== */
let pratos = [];
let ingredientesBase = [];
let impostosCache = [];
let pratoAtual = null;

/* =====================================================
   LOAD BASE
===================================================== */
async function carregarIngredientesBase(){
  const { data, error } = await sb
    .from("produtos")
    .select("*")
    .order("nome");

  if(error) return alert("Erro ingredientes");
  ingredientesBase = data;
}

async function carregarPratos(){
  const { data, error } = await sb
    .from("buffet")
    .select("*")
    .order("created_at",{ascending:false});

  if(error) return alert("Erro pratos");
  pratos = data;
  renderLista();
}


async function calcularCMVPercentual(prato){
  if(!prato.preco_venda || prato.preco_venda <= 0) return null;

  const { data: itens } = await sb
    .from("buffet_itens")
    .select("custo_calculado")
    .eq("buffet_id", prato.id);

  const cmvBase = (itens || []).reduce(
    (s,i)=> s + Number(i.custo_calculado || 0), 0
  );

  const { data: impostos } = await sb
    .from("impostos")
    .select("modalidade, valor")
    .eq("buffet_id", prato.id);

  let totalImpostos = 0;

  (impostos || []).forEach(i=>{
    if(i.modalidade === "FIXO")
      totalImpostos += Number(i.valor);

    if(i.modalidade === "PERCENTUAL")
      totalImpostos += (cmvBase * Number(i.valor)) / 100;
  });

  const cmvFinal = cmvBase + totalImpostos;

  return (cmvFinal / prato.preco_venda) * 100;
}

let cacheCMV = {};

async function carregarCMVCache(){
  cacheCMV = {};

  const { data: itens } = await sb
    .from("buffet_itens")
    .select("buffet_id, custo_calculado");

  const { data: impostos } = await sb
    .from("impostos")
    .select("buffet_id, modalidade, valor");

  // soma ingredientes
  (itens || []).forEach(i=>{
    cacheCMV[i.buffet_id] ??= { cmvBase:0, impostos:[] };
    cacheCMV[i.buffet_id].cmvBase += Number(i.custo_calculado || 0);
  });

  // agrupa impostos
  (impostos || []).forEach(i=>{
    cacheCMV[i.buffet_id] ??= { cmvBase:0, impostos:[] };
    cacheCMV[i.buffet_id].impostos.push(i);
  });
}








   
/* =====================================================
   LISTA
===================================================== */
function renderLista(){
  cards.innerHTML = "";

  const nomeFiltro = (filtroNome.value || "").toUpperCase().trim();
  const tipoFiltro = filtroTipo.value;

for(const p of pratos){

// if (p.ativo === false) continue;

    const nomeOk =
      !nomeFiltro || p.nome.toUpperCase().includes(nomeFiltro);
    const tipoOk =
      !tipoFiltro || p.tipo === tipoFiltro;

    if(!nomeOk || !tipoOk) continue;

    const dados = cacheCMV[p.id] || { cmvBase:0, impostos:[] };

    let totalImpostos = 0;
    dados.impostos.forEach(i=>{
      if(i.modalidade === "FIXO")
        totalImpostos += Number(i.valor);
      if(i.modalidade === "PERCENTUAL")
        totalImpostos += (dados.cmvBase * Number(i.valor)) / 100;
    });

    const cmvFinal = dados.cmvBase + totalImpostos;
    const cmvPerc =
      p.preco_venda ? (cmvFinal / p.preco_venda) * 100 : null;
    const lucro =
      p.preco_venda ? p.preco_venda - cmvFinal : null;

const c = document.createElement("div");
c.className = "card";
if (p.ativo === false) {
  c.style.opacity = "0.45";
  c.style.filter = "grayscale(1)";
}

    c.onclick = ()=>abrirModal(p);

    c.innerHTML = `
      ${p.foto_url ? `<img src="${p.foto_url}">` : ``}
      <div class="card-body">

        <h3>
          ${p.nome}
          ${cmvPerc !== null ? `
            <span class="badge"
              style="
                background:${cmvPerc > 35 ? '#fee2e2' : '#dcfce7'};
                color:${cmvPerc > 35 ? '#991b1b' : '#166534'};
                margin-left:6px">
              CMV ${cmvPerc.toFixed(1)}%
            </span>
          ` : ``}
        </h3>

        <span class="badge">${p.tipo || "-"}</span>

        <span class="badge">Custo ${moeda(cmvFinal)}</span>

        ${totalImpostos > 0
          ? `<span class="badge">Opera√ß√£o ${moeda(totalImpostos)}</span>`
          : ``}

        ${p.preco_venda
          ? `<span class="badge">Venda ${moeda(p.preco_venda)}</span>`
          : ``}

        ${lucro !== null ? `
          <span class="badge"
            style="
              background:${lucro < 0 ? '#fee2e2' : '#dcfce7'};
              color:${lucro < 0 ? '#991b1b' : '#166534'}">
            Lucro ${moeda(lucro)}
          </span>
        ` : ``}

      </div>
    `;

    cards.appendChild(c);
  }
}

/* =====================================================
   MODAL
===================================================== */
async function abrirModal(p){
  pratoAtual = p;
  modal.style.display = "flex";
  document.body.style.overflow = "hidden";
  mFoto.src = p.foto_url || "";

  /* INGREDIENTES */
  const { data: itens } = await sb
    .from("buffet_itens")
    .select("*")
    .eq("buffet_id", p.id);

  const cmvBase = itens.reduce(
    (s,i)=>s + Number(i.custo_calculado||0),0
  );

  /* IMPOSTOS / CUSTOS */
  const { data: impostos } = await sb
    .from("impostos")
    .select("*")
    .eq("buffet_id", p.id);

  impostosCache = impostos || [];

  let totalImpostos = 0;
  impostosCache.forEach(i=>{
    if(i.modalidade==="FIXO") totalImpostos += Number(i.valor);
    if(i.modalidade==="PERCENTUAL")
      totalImpostos += (cmvBase * Number(i.valor))/100;
  });

  const cmvFinal = cmvBase + totalImpostos;
  const precoVenda = Number(p.preco_venda||0);
  const lucro = precoVenda ? precoVenda - cmvFinal : 0;
  const margem = precoVenda ? (lucro/precoVenda)*100 : 0;

mBody.innerHTML = `
<h2>${p.nome}</h2>

<div style="margin:14px 0">
  <label style="font-weight:800;font-size:13px">
    STATUS DO PRATO
  </label>

  <select id="statusPrato" style="margin-top:6px">
    <option value="true">ATIVO</option>
    <option value="false">DESATIVADO</option>
  </select>
</div>

  <div style="margin:12px 0">
    <label style="font-weight:800;font-size:13px">
      FOTO DO PRATO
    </label>

    <input
      type="file"
      id="fotoPrato"
      accept="image/*"
      style="margin-top:6px"
    >
  </div>

  <p><b>CUSTO BASE:</b> ${moeda(cmvBase)}</p>
  <p><b>IMPOSTOS E CUSTOS OPERACIONAIS:</b> ${moeda(totalImpostos)}</p>
  <p><b>CUSTO FINAL:</b> ${moeda(cmvFinal)}</p>

  <hr>
  <h3>Tipo do prato</h3>

  <select id="tipoPrato">
    <option value="">SELECIONE</option>
    <option>PRATO PRINCIPAL</option>
    <option>ENTRADA</option>
    <option>SOBREMESA</option>
    <option>DRINK</option>
    <option>SUSHI</option>
    <option>ACOMPANHAMENTO</option>
  </select>

  <hr>

  <h3>Precifica√ß√£o</h3>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
    <input id="markupPerc" type="number" placeholder="Markup (%)">
    <input id="precoSugerido" readonly placeholder="Pre√ßo sugerido">
  </div>

  <button class="btn-add" style="margin-top:10px"
    onclick="salvarPrecoVenda(${cmvFinal})">
    SALVAR PRE√áO DE VENDA
  </button>

  ${precoVenda ? `
    <p><b>Pre√ßo atual:</b> ${moeda(precoVenda)}</p>
    <p><b>Lucro:</b> ${moeda(lucro)}</p>
    <p><b>Margem:</b> ${margem.toFixed(2)}%</p>
  ` : ``}

  <hr>

  <h3>Ingredientes</h3>
  ${itens.map(i=>`
    <div class="ing">
      <span>
        <b>${i.nome} ‚Äî ${moeda(i.custo_unitario)}</b><br>
        <small>${i.quantidade} ${i.unidade_uso}</small>
      </span>

      <strong>${moeda(i.custo_calculado)}</strong>

      <div style="display:flex;gap:6px">
        <button class="btn-icon btn-edit"
          onclick="editarIngrediente('${i.id}')">‚úèÔ∏è</button>
        <button class="btn-icon btn-delete"
          onclick="excluirIngrediente('${i.id}')">üóëÔ∏è</button>
      </div>
    </div>
  `).join("")}

  <div class="precificacao">
    <h3>Novo ingrediente</h3>

    <select id="ingProduto">
      <option value="">Selecione</option>
      ${ingredientesBase.map(i=>`
        <option value="${i.id}"
          data-custo="${i.valor}"
          data-unidade="${i.unidade_medida}">
          ${i.nome}
        </option>
      `).join("")}
    </select>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <input id="ingQtd" type="number" step="0.001" placeholder="Quantidade">
      <input id="ingUnidade" readonly placeholder="Unidade">
    </div>

    <button class="btn-add" style="margin-top:10px"
      onclick="salvarIngrediente()">ADICIONAR INGREDIENTE</button>
  </div>

  <hr>

  <h3>Custos / Impostos</h3>
  ${impostosCache.map(i=>`
    <div class="ing">
      <span>
        <b>${i.descricao}</b><br>
        <small>${i.tipo} ‚Ä¢ ${i.modalidade === "PERCENTUAL" ? i.valor+"%" : moeda(i.valor)}</small>
      </span>
      <strong>
        ${i.modalidade==="PERCENTUAL"
          ? moeda((cmvBase*i.valor)/100)
          : moeda(i.valor)}
      </strong>
      <button class="btn-icon btn-delete"
        onclick="excluirImposto('${i.id}')">üóëÔ∏è</button>
    </div>
  `).join("")}

  <div class="precificacao">
    <h3>Novo custo / imposto</h3>

    <input id="impDesc" placeholder="Descri√ß√£o">

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <select id="impTipo">
        <option value="IMPOSTO">IMPOSTO</option>
        <option value="CUSTO">CUSTO</option>
      </select>

      <select id="impModalidade">
        <option value="FIXO">VALOR FIXO</option>
        <option value="PERCENTUAL">PERCENTUAL (%)</option>
      </select>
    </div>

    <input id="impValor" type="number" step="0.01" placeholder="Valor">

    <button class="btn-add" style="margin-top:10px"
      onclick="salvarImposto()">ADICIONAR</button>
  </div>
<hr>

<h3>Modo de preparo</h3>

<textarea
  id="modoPreparo"
  placeholder="Descreva o modo de preparo do prato..."
  style="
    width:100%;
    min-height:120px;
    padding:14px;
    border-radius:14px;
    border:1px solid var(--border);
    font-size:14px;
    font-family:Inter,sans-serif;
    resize:vertical;
  "
>${p.modo_preparo || ""}</textarea>


  
`;
setTimeout(() => {
  const selectTipo = document.getElementById("tipoPrato");
  if (!selectTipo) return;

  if (p.tipo) {
    selectTipo.value = p.tipo;
  }

  selectTipo.onchange = async () => {
    const tipo = selectTipo.value;
    if (!tipo) return;

    await sb
      .from("buffet")
      .update({ tipo })
      .eq("id", pratoAtual.id);

    await carregarPratos();
    renderLista();
  };
}, 0);
setTimeout(() => {
  const inputFoto = document.getElementById("fotoPrato");
  if (!inputFoto) return;

  inputFoto.onchange = async () => {
    const file = inputFoto.files[0];
    if (!file) return;

    const ext = file.name.split(".").pop();
    const fileName = `${pratoAtual.id}.${ext}`;

    const { error: uploadError } = await sb.storage
      .from("buffet")
      .upload(fileName, file, { upsert: true });

    if (uploadError) {
      alert("Erro ao enviar imagem");
      return;
    }

    const { data } = sb.storage
      .from("buffet")
      .getPublicUrl(fileName);

    const fotoUrl = data.publicUrl;

    await sb
      .from("buffet")
      .update({ foto_url: fotoUrl })
      .eq("id", pratoAtual.id);

    mFoto.src = fotoUrl;

    await carregarPratos();
    renderLista();
  };
}, 0);

  setTimeout(() => {
    const selectTipo = document.getElementById("tipoPrato");
    if (selectTipo && p.tipo) {
      selectTipo.value = p.tipo;
    }
  }, 0);
setTimeout(() => {
  const statusSelect = document.getElementById("statusPrato");
  if (!statusSelect) return;

  statusSelect.value = p.ativo === false ? "false" : "true";

  statusSelect.onchange = async () => {
    const ativo = statusSelect.value === "true";

    await sb
      .from("buffet")
      .update({ ativo })
      .eq("id", pratoAtual.id);

    await carregarPratos();
    renderLista();
  };
}, 0);
setTimeout(() => {
  const mp = document.getElementById("modoPreparo");
  if (!mp) return;

  const valorInicial = (p.modo_preparo || "").trim();

  mp.onblur = async () => {
    const textoAtual = mp.value.trim();

    // ‚ùå n√£o mudou ‚Üí n√£o salva
    if (textoAtual === valorInicial) return;

    await sb
      .from("buffet")
      .update({ modo_preparo: textoAtual })
      .eq("id", pratoAtual.id);
  };
}, 0);


  setTimeout(()=>{
    markupPerc.oninput = ()=>{
      const mk = Number(markupPerc.value||0);
      precoSugerido.value = moeda(cmvFinal * (1 + mk/100));
    };
  },50);

} // ‚úÖ FECHA abrirModal(p)


/* =====================================================
   A√á√ïES
===================================================== */
async function salvarPrecoVenda(cmvFinal){
  const mk = Number(markupPerc.value||0);
  if(mk<=0) return alert("Informe o markup");

  const preco = cmvFinal * (1 + mk/100);

  await sb.from("buffet")
    .update({ preco_venda: preco })
    .eq("id", pratoAtual.id);

  await carregarPratos();
  abrirModal(pratos.find(p=>p.id===pratoAtual.id));
}

async function salvarIngrediente(){
  const prodId = ingProduto.value;
  const qtd = Number(ingQtd.value||0);
  if(!prodId || qtd<=0) return;

const prod = ingredientesBase.find(p => p.id === prodId);
const custoUnit = Number(prod.valor);

await sb.from("buffet_itens").insert({
  buffet_id: pratoAtual.id,
  produto_id: prod.id,
  nome: prod.nome,
  quantidade: qtd,
  unidade_uso: prod.unidade_medida,
  custo_unitario: custoUnit,
  custo_calculado: custoUnit * qtd
});


  abrirModal(pratoAtual);
}

async function excluirIngrediente(itemId){
  if(!confirm("Excluir este ingrediente?")) return;

  await sb
    .from("buffet_itens")
    .delete()
    .eq("id", itemId);

  abrirModal(pratoAtual);
}


async function salvarImposto(){
  const desc = impDesc.value.trim();
  const tipo = impTipo.value;
  const modalidade = impModalidade.value;
  const valor = Number(impValor.value||0);

  if(!desc || valor<=0) return;

  await sb.from("impostos").insert({
    buffet_id: pratoAtual.id,
    descricao: desc,
    tipo,
    modalidade,
    valor
  });

  abrirModal(pratoAtual);
}

async function excluirImposto(id){
  await sb.from("impostos").delete().eq("id",id);
  abrirModal(pratoAtual);
}

/* =====================================================
   AUTO UNIDADE
===================================================== */
document.addEventListener("change", e => {
  if (e.target.id === "ingProduto") {
    const opt = e.target.selectedOptions[0];
    ingUnidade.value = opt?.dataset?.unidade || "";
  }
});


function fechar(){
  modal.style.display="none";
  document.body.style.overflow="";
}

/* =====================================================
   INIT
===================================================== */
(async ()=>{
  await carregarIngredientesBase();
  await carregarPratos();
  await carregarCMVCache();
  renderLista();
})();


async function editarIngrediente(itemId){
  const { data, error } = await sb
    .from("buffet_itens")
    .select("*")
    .eq("id", itemId)
    .single();

  if(error){
    alert("Erro ao carregar ingrediente");
    return;
  }

  // preenche formul√°rio
  ingProduto.value = data.produto_id;
  ingQtd.value = data.quantidade;
  ingUnidade.value = data.unidade_uso;

  const btn = document.querySelector(".precificacao .btn-add");
  btn.innerText = "ATUALIZAR INGREDIENTE";

  btn.onclick = async () => {
    const qtd = Number(ingQtd.value || 0);
    if(qtd <= 0) return alert("Quantidade inv√°lida");

    const prod = ingredientesBase.find(p => p.id === ingProduto.value);
    const custoUnit = Number(prod.valor);

    await sb
      .from("buffet_itens")
      .update({
        quantidade: qtd,
        custo_unitario: custoUnit,
        custo_calculado: custoUnit * qtd
      })
      .eq("id", itemId);

    btn.innerText = "ADICIONAR INGREDIENTE";
    btn.onclick = salvarIngrediente;

    ingProduto.value = "";
    ingQtd.value = "";
    ingUnidade.value = "";

    abrirModal(pratoAtual);
  };
}
filtroNome.addEventListener("input", () => {
  renderLista();
});

filtroTipo.addEventListener("change", () => {
  renderLista();
});


 

</script>



</body>
</html>
