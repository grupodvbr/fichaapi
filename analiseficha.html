<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>CMV ‚Ä¢ Fichas T√©cnicas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --primary:#2563eb;
  --success:#16a34a;
  --danger:#dc2626;
  --bg:#f8fafc;
  --card:#ffffff;
  --text:#0f172a;
  --muted:#64748b;
}

*{
  box-sizing:border-box;
  -webkit-font-smoothing:antialiased;
}

body{
  margin:0;
  font-family:Inter,sans-serif;
  background:var(--bg);
  color:var(--text);
}

/* ================= GRID ================= */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(340px,1fr));
  gap:22px;
  padding:22px;
}

/* ================= CARD ================= */
.card{
  background:var(--card);
  border-radius:24px;
  box-shadow:0 18px 40px rgba(0,0,0,.08);
  overflow:hidden;
  cursor:pointer;
  transition:transform .15s ease, box-shadow .15s ease;
}

.card:hover{
  transform:translateY(-4px);
  box-shadow:0 26px 60px rgba(0,0,0,.12);
}

.card img{
  width:100%;
  height:180px;
  object-fit:cover;
}

.card-body{
  padding:18px;
}

.card-body h3{
  margin:0 0 8px;
  font-weight:800;
}

/* ================= BADGES ================= */
.badge{
  display:inline-block;
  padding:6px 12px;
  border-radius:999px;
  background:#e0f2fe;
  color:#0369a1;
  font-size:12px;
  font-weight:800;
  margin:4px 6px 0 0;
}

/* ================= MODAL OVERLAY ================= */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:100;
}

/* ================= MODAL BOX ================= */
.modal-box{
  background:#fff;
  width:100%;
  max-width:820px;
  max-height:90vh;
  border-radius:28px;
  overflow:hidden;
  display:flex;
  flex-direction:column;
  box-shadow:0 30px 80px rgba(0,0,0,.35);
  animation:modalIn .25s ease;
}

@keyframes modalIn{
  from{transform:translateY(20px);opacity:0}
  to{transform:translateY(0);opacity:1}
}

/* ================= MODAL IMAGE ================= */
.modal-img{
  width:100%;
  height:240px;
  object-fit:cover;
  flex-shrink:0;
}

/* ================= MODAL BODY ================= */
.modal-body{
  padding:26px;
  overflow-y:auto;
}

/* ================= SCROLL BONITO ================= */
.modal-body::-webkit-scrollbar{
  width:8px;
}

.modal-body::-webkit-scrollbar-track{
  background:#f1f5f9;
}

.modal-body::-webkit-scrollbar-thumb{
  background:#cbd5e1;
  border-radius:8px;
}

.modal-body::-webkit-scrollbar-thumb:hover{
  background:#94a3b8;
}

/* ================= FECHAR ================= */
.close{
  position:absolute;
  top:14px;
  right:18px;
  font-size:24px;
  cursor:pointer;
  font-weight:900;
  z-index:10;
  color:#fff;
  text-shadow:0 2px 6px rgba(0,0,0,.6);
}

/* ================= TEXTOS MODAL ================= */
.modal-body h2{
  margin:0 0 10px;
  font-weight:900;
}

.modal-body p{
  margin:6px 0;
  color:var(--muted);
  font-size:14px;
}

.modal-body hr{
  border:none;
  height:1px;
  background:#e5e7eb;
  margin:18px 0;
}

/* ================= INGREDIENTES ================= */
.ing{
  display:grid;
  grid-template-columns:1fr auto auto;
  gap:14px;
  font-size:14px;
  padding:12px 0;
  border-bottom:1px solid #e5e7eb;
}

.ing:last-child{
  border-bottom:none;
}

.ing b{
  font-weight:800;
}

.ing small{
  color:var(--muted);
}

/* ================= LUCRO ================= */
.lucro{
  font-size:16px;
  margin-top:8px;
}

.lucro.pos{
  color:var(--success);
  font-weight:900;
}

.lucro.neg{
  color:var(--danger);
  font-weight:900;
}

/* ================= RESPONSIVO ================= */
@media(max-width:600px){
  .modal-box{
    max-width:94%;
    border-radius:22px;
  }

  .modal-img{
    height:200px;
  }

  .ing{
    grid-template-columns:1fr auto;
  }

  .ing span:last-child{
    grid-column:2;
  }
}
/* ================= FILTROS ================= */
.filters{
  display:flex;
  gap:14px;
  padding:22px 22px 0;
  flex-wrap:wrap;
}

.filters input,
.filters select{
  padding:14px 18px;
  border-radius:999px;
  border:1px solid #e5e7eb;
  font-size:14px;
  font-weight:600;
  outline:none;
  background:#fff;
}

.filters input{
  flex:1;
  min-width:220px;
}

.filters select{
  min-width:180px;
}

.filters input:focus,
.filters select:focus{
  border-color:var(--primary);
  box-shadow:0 0 0 3px rgba(37,99,235,.15);
}
/* ================= FORM IMPOSTOS ================= */
.form-impostos{
  margin-top:14px;
  display:grid;
  grid-template-columns:2fr 1fr 1fr 1fr auto;
  gap:10px;
  align-items:center;
}

/* INPUTS E SELECTS */
.form-impostos input,
.form-impostos select{
  height:42px;
  padding:0 14px;
  border-radius:10px;
  border:1px solid #e5e7eb;
  font-size:14px;
  font-weight:600;
  background:#fff;
  color:var(--text);
  outline:none;
  transition:border .15s ease, box-shadow .15s ease;
}

.form-impostos input::placeholder{
  color:#94a3b8;
  font-weight:500;
}

.form-impostos input:focus,
.form-impostos select:focus{
  border-color:var(--primary);
  box-shadow:0 0 0 3px rgba(37,99,235,.15);
}

/* BOT√ÉO ADICIONAR */
.btn-add{
  height:42px;
  padding:0 18px;
  border-radius:10px;
  border:none;
  background:linear-gradient(135deg, #2563eb, #1d4ed8);
  color:#fff;
  font-size:13px;
  font-weight:900;
  letter-spacing:.04em;
  cursor:pointer;
  box-shadow:0 6px 18px rgba(37,99,235,.35);
  transition:transform .12s ease, box-shadow .12s ease, opacity .12s ease;
}

.btn-add:hover{
  transform:translateY(-1px);
  box-shadow:0 10px 28px rgba(37,99,235,.45);
}

.btn-add:active{
  transform:translateY(0);
  box-shadow:0 6px 16px rgba(37,99,235,.35);
}

.btn-add:disabled{
  opacity:.5;
  cursor:not-allowed;
  box-shadow:none;
}

/* LISTAGEM DE IMPOSTOS */
.lista-impostos .ing{
  display:grid;
  grid-template-columns:1fr auto;
  gap:12px;
  align-items:center;
}

.lista-impostos .ing strong{
  font-weight:900;
  color:#0f172a;
}

/* RESPONSIVO */
@media(max-width:700px){
  .form-impostos{
    grid-template-columns:1fr;
  }

  .btn-add{
    width:100%;
  }
}

  
</style>
</head>

<body>
<div class="filters">
  <input id="filtroNome" type="text" placeholder="Buscar por nome do prato">
  <select id="filtroTipo">
    <option value="">Todos os tipos</option>
    <option value="SUSHI">SUSHI</option>
    <option value="DRINK">DRINK</option>
    <option value="ENTRADA">ENTRADA</option>
    <option value="PRATO PRINCIPAL">PRATO PRINCIPAL</option>
    <option value="SOBREMESA">SOBREMESA</option>
    <option value="ACOMPANHAMENTO">ACOMPANHAMENTO</option>
  </select>
</div>

<div id="cards" class="grid"></div>

<!-- MODAL -->
<div id="modal" class="modal" onclick="fechar()">
  <div class="modal-box" onclick="event.stopPropagation()">
    <span class="close" onclick="fechar()">‚úï</span>
    <img id="mFoto" class="modal-img">
    <div id="mBody" class="modal-body"></div>
  </div>
</div>

<script>
/* ================= SUPABASE ================= */
const sb = supabase.createClient(
  "https://dxkszikemntfusfyrzos.supabase.co",
  "sb_publishable_NNFvdfSXgOdGGVcSbphbjQ_brC3_9ed"
);

const moeda = v =>
  "R$ " + Number(v || 0).toLocaleString("pt-BR",{minimumFractionDigits:2});

/* ================= STATE ================= */
let pratos = [];
let impostosCache = [];

/* ================= LOAD PRATOS ================= */
async function carregarPratos(){
  const { data, error } = await sb
    .from("buffet")
    .select("*")
    .order("created_at",{ascending:false});

  if(error){
    console.error(error);
    alert("Erro ao carregar pratos");
    return;
  }

  pratos = data;
  renderLista();
}

/* ================= FILTROS ================= */
function renderLista(){
  cards.innerHTML = "";

  const nomeFiltro = (filtroNome?.value || "").toUpperCase();
  const tipoFiltro = filtroTipo?.value || "";

  pratos
    .filter(p =>
      (!nomeFiltro || p.nome.toUpperCase().includes(nomeFiltro)) &&
      (!tipoFiltro || p.tipo === tipoFiltro)
    )
    .forEach(renderCard);
}

/* ================= CARD ================= */
function renderCard(p){
  const c = document.createElement("div");
  c.className = "card";
  c.onclick = ()=>abrir(p);

  c.innerHTML = `
    ${p.foto_url ? `<img src="${p.foto_url}">` : ``}
    <div class="card-body">
      <h3>${p.nome}</h3>
      <span class="badge">${p.tipo || "-"}</span>
      <span class="badge">CMV ${moeda(p.custo_unitario)}</span>
      ${Number(p.preco_venda) > 0 ? `<span class="badge">Venda ${moeda(p.preco_venda)}</span>` : ``}
    </div>
  `;
  cards.appendChild(c);
}

/* ================= MODAL ================= */
async function abrir(p){
  document.body.style.overflow = "hidden";
  modal.style.display = "flex";
  mFoto.src = p.foto_url || "";

  /* INGREDIENTES */
  const { data: itens } = await sb
    .from("buffet_itens")
    .select("*")
    .eq("buffet_id", p.id);

  const cmv = itens.reduce((s,i)=>s + Number(i.custo_calculado||0),0);

  /* IMPOSTOS / CUSTOS */
  const { data: impostos } = await sb
    .from("impostos")
    .select("*")
    .eq("buffet_id", p.id);

  impostosCache = impostos || [];

let totalImpostos = 0;

impostosCache.forEach(i => {
  const valor = Number(i.valor || 0);

  if (i.modalidade === "FIXO") {
    totalImpostos += valor;
  }

  if (i.modalidade === "PERCENTUAL") {
    totalImpostos += (cmv * valor) / 100;
  }
});
  const precoVenda = Number(p.preco_venda||0);
  const lucro = precoVenda > 0 ? precoVenda - (cmv + totalImpostos) : 0;
const margem =
  precoVenda > 0 && lucro !== 0
    ? (lucro / precoVenda) * 100
    : 0;

  mBody.innerHTML = `
    <h2>${p.nome}</h2>

    ${precoVenda > 0 ? `<p><b>Pre√ßo de venda:</b> ${moeda(precoVenda)}</p>` : ``}
    <p><b>CMV:</b> ${moeda(cmv)}</p>
    <p><b>Impostos / Custos:</b> ${moeda(totalImpostos)}</p>

    ${precoVenda > 0 ? `
      <p><b>Lucro:</b> ${moeda(lucro)}</p>
      <p><b>Margem:</b> ${margem.toFixed(2)}%</p>
    ` : `
      <p style="color:#dc2626;font-weight:700">
        ‚ö†Ô∏è Pre√ßo de venda n√£o cadastrado
      </p>
    `}

    <hr>
    <h3>Ingredientes</h3>

    ${itens.map(i=>`
      <div class="ing">
        <span>
          <b>${i.nome}</b><br>
          <small>${i.quantidade} ${i.unidade_uso}</small>
        </span>
        <strong>${moeda(i.custo_calculado)}</strong>
      </div>
    `).join("")}

<hr>
<h3>Impostos / Custos adicionais</h3>

<div class="lista-impostos">
  ${
    impostosCache.length === 0
      ? `<p style="color:#64748b">Nenhum imposto ou custo adicional.</p>`
      : impostosCache.map(i => {
          const valorCalculado =
            i.modalidade === "PERCENTUAL"
              ? (cmv * Number(i.valor)) / 100
              : Number(i.valor);

          const label =
            i.modalidade === "PERCENTUAL"
              ? `${i.valor}%`
              : "Valor fixo";

          return `
            <div class="ing" style="align-items:center">
              <span>
                <b>${i.descricao}</b><br>
                <small>${i.tipo} ‚Ä¢ ${label}</small>
              </span>

              <strong>${moeda(valorCalculado)}</strong>

              <div style="display:flex;gap:6px">
                <button onclick="editarImposto('${i.id}', '${p.id}')" 
                        style="background:#e0f2fe;border:none;border-radius:6px;padding:6px 10px;cursor:pointer;font-weight:700">
                  ‚úèÔ∏è
                </button>

                <button onclick="excluirImposto('${i.id}', '${p.id}')" 
                        style="background:#fee2e2;border:none;border-radius:6px;padding:6px 10px;cursor:pointer;font-weight:700">
                  üóëÔ∏è
                </button>
              </div>
            </div>
          `;
        }).join("")
  }
</div>


<div style="margin-top:12px;display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:8px">
  <input id="impDesc" placeholder="Descri√ß√£o">

  <select id="impTipo">
    <option value="IMPOSTO">IMPOSTO</option>
    <option value="CUSTO">CUSTO</option>
  </select>

  <select id="impModalidade">
    <option value="FIXO">VALOR FIXO</option>
    <option value="PERCENTUAL">PERCENTUAL (%)</option>
  </select>

  <input id="impValor" type="number" step="0.01" placeholder="Valor">
</div>

<button style="margin-top:12px" onclick="salvarImposto('${p.id}')">
  ADICIONAR
</button>

  `;
}
async function salvarImposto(buffetId){
  const desc = impDesc.value.trim();
  const tipo = impTipo.value;
  const modalidade = impModalidade.value;
  const valor = Number(impValor.value || 0);

  if(!desc || valor <= 0){
    alert("Preencha descri√ß√£o e valor");
    return;
  }

  const { error } = await sb
    .from("impostos")
    .insert({
      buffet_id: buffetId,
      descricao: desc,
      tipo,
      modalidade,
      valor
    });

  if(error){
    console.error("ERRO IMPOSTO:", error);
    alert(error.message);
    return;
  }

  // limpa campos
  impDesc.value = "";
  impValor.value = "";

  // recarrega modal
  abrir(pratos.find(p => p.id === buffetId));
}
async function excluirImposto(impostoId, buffetId){
  if(!confirm("Deseja excluir este custo/imposto?")) return;

  const { error } = await sb
    .from("impostos")
    .delete()
    .eq("id", impostoId);

  if(error){
    console.error(error);
    alert("Erro ao excluir");
    return;
  }

  abrir(pratos.find(p => p.id === buffetId));
}
async function editarImposto(impostoId, buffetId){
  const imposto = impostosCache.find(i => i.id === impostoId);
  if(!imposto) return;

  impDesc.value = imposto.descricao;
  impTipo.value = imposto.tipo;
  impModalidade.value = imposto.modalidade;
  impValor.value = imposto.valor;

  // muda bot√£o para salvar edi√ß√£o
  const btn = document.querySelector(".btn-add");
  btn.innerText = "SALVAR";
  btn.onclick = async () => {
    const desc = impDesc.value.trim();
    const tipo = impTipo.value;
    const modalidade = impModalidade.value;
    const valor = Number(impValor.value || 0);

    if(!desc || valor <= 0){
      alert("Preencha descri√ß√£o e valor");
      return;
    }

    const { error } = await sb
      .from("impostos")
      .update({
        descricao: desc,
        tipo,
        modalidade,
        valor
      })
      .eq("id", impostoId);

    if(error){
      console.error(error);
      alert("Erro ao atualizar");
      return;
    }

    // restaura bot√£o
    btn.innerText = "ADICIONAR";
    btn.onclick = () => salvarImposto(buffetId);

    impDesc.value = "";
    impValor.value = "";

    abrir(pratos.find(p => p.id === buffetId));
  };
}

/* ================= FECHAR ================= */
function fechar(){
  modal.style.display = "none";
  document.body.style.overflow = "";
}

/* ================= INIT ================= */
carregarPratos();

  
</script>


</body>
</html>
