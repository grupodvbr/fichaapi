<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>CMV â€¢ Home Premium</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#0b1220; --card:#020617; --grid:#1e293b;
  --text:#e5e7eb; --muted:#94a3b8;
  --accent:#22c55e; --danger:#ef4444; --gold:#f59e0b;
  --radius:18px; --shadow:0 20px 60px rgba(0,0,0,.45);
}
*{box-sizing:border-box}
body{
  margin:0; font-family:Inter,sans-serif; color:var(--text);
  background:radial-gradient(1200px 600px at 10% -10%, #0b1220 0%, #020617 60%);
}
.header{padding:18px 24px;border-bottom:1px solid var(--grid);background:#020617cc;position:sticky;top:0;z-index:10}
.container{padding:22px 24px 40px;max-width:1400px;margin:auto}
.filters{display:flex;gap:10px;margin-bottom:16px}
.select{background:#020617;color:#fff;border:1px solid var(--grid);border-radius:999px;padding:8px 14px;font-weight:800}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin-bottom:26px}
.card{background:#020617;border:1px solid var(--grid);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow)}
.card small{color:var(--muted);font-weight:800;font-size:11px;text-transform:uppercase}
.card b{display:block;margin-top:6px;font-size:32px;font-weight:900;color:var(--accent)}
.card.warn b{color:var(--gold)} .card.danger b{color:var(--danger)}
.section{display:grid;grid-template-columns:repeat(2,1fr);gap:18px}
@media(max-width:900px){.section{grid-template-columns:1fr}}
.panel{background:#020617;border:1px solid var(--grid);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
.panel h3{margin:0 0 10px;font-size:14px;font-weight:900;color:#cbd5f5}
.badge{display:inline-block;padding:6px 12px;border-radius:999px;font-size:12px;font-weight:800;border:1px solid var(--grid);background:#0b1220;margin:4px}
</style>
</head>
<body>

<div class="header">
  <small id="atualizadoEm"></small>
</div>

<div class="container">

  <div class="filters">
    <span class="badge">Filtrar por tipo</span>
    <select id="filtroTipo" class="select"></select>
  </div>

  <div class="grid">
    <div class="card"><small>Fichas</small><b id="kpiFichas">â€”</b></div>
    <div class="card"><small>Produtos</small><b id="kpiProdutos">â€”</b></div>
    <div class="card warn"><small>Produto Top</small><b id="kpiProdutoTop">â€”</b></div>
    <div class="card"><small>CMV MÃ©dio</small><b id="kpiCmvMedio">â€”%</b></div>
    <div class="card"><small>PreÃ§o MÃ©dio</small><b id="kpiPrecoMedio">â€”</b></div>
    <div class="card"><small>Custo MÃ©dio</small><b id="kpiCustoMedio">â€”</b></div>
    <div class="card warn"><small>Lucro Total</small><b id="kpiLucroTotal">â€”</b></div>
    <div class="card danger"><small>CMV Alto</small><b id="kpiCmvAlto">â€”</b></div>
  </div>

  <div class="section">
    <div class="panel"><h3>ðŸ“Š CMV por tipo</h3><canvas id="graficoTipo"></canvas></div>
    <div class="panel"><h3>ðŸ¥‡ Produtos mais usados</h3><canvas id="graficoProdutos"></canvas></div>
    <div class="panel"><h3>ðŸš¨ CMV mais alto</h3><div id="listaCmvAlto"></div></div>
    <div class="panel"><h3>ðŸ’Ž Mais lucrativos</h3><div id="listaLucro"></div></div>
  </div>

</div>

<script>
const sb = supabase.createClient(
  "https://dxkszikemntfusfyrzos.supabase.co",
  "sb_publishable_NNFvdfSXgOdGGVcSbphbjQ_brC3_9ed"
);

const moeda = v => "R$ " + Number(v||0).toLocaleString("pt-BR",{minimumFractionDigits:2});
let chartTipo, chartProdutos;

async function carregarTipos(){
  const { data } = await sb.from("buffet").select("tipo");
  const tipos = [...new Set((data||[]).map(i=>i.tipo).filter(Boolean))].sort();
  filtroTipo.innerHTML = `<option value="">Todos</option>` + tipos.map(t=>`<option value="${t}">${t}</option>`).join("");
}

async function carregarHome(){
  atualizadoEm.textContent = "Atualizado em " + new Date().toLocaleString("pt-BR");

  const tipo = filtroTipo.value;
  const q = sb.from("buffet").select("*");
  const { data: buffet } = tipo ? await q.eq("tipo", tipo) : await q;

  const { data: itens } = await sb.from("buffet_itens").select("*");
  const { data: produtos } = await sb.from("produtos").select("*");

  kpiFichas.textContent = buffet?.length || 0;
  kpiProdutos.textContent = produtos?.length || 0;

  const custoFicha = {};
  const usoProdutos = {};

  itens.forEach(i=>{
    custoFicha[i.buffet_id] = (custoFicha[i.buffet_id]||0) + Number(i.custo_calculado||0);
    usoProdutos[i.nome] = (usoProdutos[i.nome]||0) + 1;
  });

  const topProduto = Object.entries(usoProdutos).sort((a,b)=>b[1]-a[1])[0];
  if(topProduto) kpiProdutoTop.textContent = topProduto[0];

  let somaCMV=0,qtd=0,precoT=0,custoT=0,lucroT=0,cmvAlto=0;
  const rankingCmv=[], rankingLucro=[], cmvTipo={}, qtdTipo={};

  buffet.forEach(b=>{
    const custo = custoFicha[b.id]||0;
    const preco = Number(b.preco_venda||0);
    if(preco>0){
      const cmv = (custo/preco)*100;
      const lucro = preco - custo;
      somaCMV+=cmv; qtd++; precoT+=preco; custoT+=custo; lucroT+=lucro;
      if(cmv>35) cmvAlto++;
      cmvTipo[b.tipo]=(cmvTipo[b.tipo]||0)+cmv;
      qtdTipo[b.tipo]=(qtdTipo[b.tipo]||0)+1;
      rankingCmv.push({nome:b.nome,cmv});
      rankingLucro.push({nome:b.nome,lucro});
    }
  });

  kpiCmvMedio.textContent=(somaCMV/qtd||0).toFixed(1);
  kpiPrecoMedio.textContent=moeda(precoT/qtd||0);
  kpiCustoMedio.textContent=moeda(custoT/qtd||0);
  kpiLucroTotal.textContent=moeda(lucroT);
  kpiCmvAlto.textContent=cmvAlto;

  chartTipo?.destroy();
  chartTipo = new Chart(graficoTipo,{
    type:"bar",
    data:{labels:Object.keys(cmvTipo),datasets:[{data:Object.keys(cmvTipo).map(k=>(cmvTipo[k]/qtdTipo[k]).toFixed(1))}]},
    options:{plugins:{legend:{display:false}}}
  });

  chartProdutos?.destroy();
  const topProdutos = Object.entries(usoProdutos).sort((a,b)=>b[1]-a[1]).slice(0,5);
  chartProdutos = new Chart(graficoProdutos,{
    type:"bar",
    data:{labels:topProdutos.map(i=>i[0]),datasets:[{data:topProdutos.map(i=>i[1])}]},
    options:{plugins:{legend:{display:false}}}
  });

  listaCmvAlto.innerHTML = rankingCmv.sort((a,b)=>b.cmv-a.cmv).slice(0,5)
    .map(i=>`<span class="badge">${i.nome} â€” ${i.cmv.toFixed(1)}%</span>`).join("");

  listaLucro.innerHTML = rankingLucro.sort((a,b)=>b.lucro-a.lucro).slice(0,5)
    .map(i=>`<span class="badge">${i.nome} â€” ${moeda(i.lucro)}</span>`).join("");
}

filtroTipo.onchange = carregarHome;

(async ()=>{
  await carregarTipos();
  await carregarHome();
})();
</script>
</body>
</html>
