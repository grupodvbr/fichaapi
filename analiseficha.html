<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>CMV ‚Ä¢ Fichas T√©cnicas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* =========================================================
   VARI√ÅVEIS
========================================================= */
:root{
  --primary:#2563eb;
  --primary-dark:#1e40af;
  --success:#16a34a;
  --danger:#dc2626;
  --warning:#f59e0b;

  --bg:#f8fafc;
  --card:#ffffff;
  --text:#0f172a;
  --muted:#64748b;
  --border:#e5e7eb;

  --radius-lg:26px;
  --radius-md:14px;
  --radius-sm:8px;

  --shadow-xs:0 2px 6px rgba(0,0,0,.06);
  --shadow-sm:0 6px 16px rgba(0,0,0,.08);
  --shadow-md:0 18px 40px rgba(0,0,0,.12);
  --shadow-lg:0 40px 90px rgba(0,0,0,.35);
}

/* =========================================================
   RESET / BASE
========================================================= */
*{
  box-sizing:border-box;
  -webkit-font-smoothing:antialiased;
}

body{
  margin:0;
  font-family:Inter,sans-serif;
  background:
    radial-gradient(1200px 500px at 10% -10%, #eef2ff 0%, transparent 60%),
    radial-gradient(1200px 500px at 110% 10%, #ecfeff 0%, transparent 60%),
    var(--bg);
  color:var(--text);
}

/* trava scroll quando modal aberto */
body.modal-open{
  overflow:hidden;
  position:fixed;
  width:100%;
}

/* =========================================================
   FILTROS
========================================================= */
.filters{
  display:flex;
  gap:14px;
  padding:22px 22px 8px;
  flex-wrap:wrap;
}

.filters input,
.filters select{
  padding:14px 18px;
  border-radius:999px;
  border:1px solid var(--border);
  font-size:14px;
  font-weight:700;
  width:100%;
  max-width:320px;
  background:#fff;
  box-shadow:var(--shadow-xs);
}

.filters input:focus,
.filters select:focus{
  outline:none;
  border-color:var(--primary);
  box-shadow:0 0 0 3px rgba(37,99,235,.18), var(--shadow-xs);
}

/* =========================================================
   GRID PRINCIPAL
========================================================= */
.grid{
  display:grid;
  grid-template-columns:repeat(6, 1fr);
  gap:22px;
  padding:22px;
}

/* =========================================================
   CARD
========================================================= */
.card{
  background:var(--card);
  border-radius:22px;
  box-shadow:var(--shadow-md);
  overflow:hidden;
  cursor:pointer;
  transition:.18s ease;
  border:1px solid rgba(0,0,0,.03);
}

.card:hover{
  transform:translateY(-4px) scale(1.005);
  box-shadow:0 28px 70px rgba(0,0,0,.22);
}

.card img{
  width:100%;
  height:280px;
  object-fit:cover;
  transition:.3s ease;
}

.card:hover img{
  transform:scale(1.04);
}

.card-body{
  padding:18px;
}

.card-body h3{
  margin:0 0 6px;
  font-weight:900;
  font-size:16px;
  letter-spacing:-.01em;
}

/* =========================================================
   BADGES
========================================================= */
.badges{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  margin-top:6px;
}

.badges.primary{ margin-top:6px; }
.badges.secondary{ margin-top:10px; }

.badge{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:6px 12px;
  border-radius:999px;
  background:#eef2ff;
  color:#3730a3;
  font-size:12px;
  font-weight:900;
  letter-spacing:.02em;
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.5);
  backdrop-filter:blur(2px);
}

/* =========================================================
   MODAL OVERLAY
========================================================= */
.modal{
  position:fixed;
  inset:0;
  background:linear-gradient(
    180deg,
    rgba(15,23,42,.65),
    rgba(15,23,42,.75)
  );
  backdrop-filter:blur(6px);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:100;
}

/* =========================================================
   MODAL BOX
========================================================= */
.modal-box{
  background:#fff;
  width:96vw;
  max-width:1440px; /* antes: 1200px */
  max-height:92vh;
  border-radius:26px;
  overflow:hidden;
  display:flex;
  flex-direction:column;
  box-shadow:var(--shadow-lg);
  animation:modalIn .2s ease;
  position:relative;
}

@keyframes modalIn{
  from{ opacity:0; transform:scale(.96) }
  to{ opacity:1; transform:scale(1) }
}

/* =========================================================
   HEADER DO MODAL
========================================================= */
.modal-header{
  display:grid;
  grid-template-columns:34% 66%;
  gap:22px;
  padding:22px 26px;
  border-bottom:1px solid var(--border);
  background:
    radial-gradient(500px 200px at 10% -20%, #eef2ff 0%, transparent 60%),
    #fff;
}

.modal-left{
  border-radius:22px;
  overflow:hidden;
  box-shadow:0 30px 80px rgba(0,0,0,.45);
  background:#000;
  height:100%;
  min-height:260px;     /* üëà diminui */
  max-height:360px;     /* üëà trava a altura */
}

.modal-img{
  width:100%;
  height:100%;
  object-fit:contain;   /* üëà mostra inteira (se preferir menos corte) */
  background:#000;     /* üëà fundo elegante se sobrar borda */
  display:block;
}

/* =========================================================
   COLUNA DIREITA DO MODAL
========================================================= */
.modal-main{
  display:flex;
  flex-direction:column;
  gap:18px;
  padding:10px 6px 18px;
  overflow:hidden;
}

.modal-main h2{
  margin:0;
  font-size:34px;
  font-weight:900;
  letter-spacing:-.03em;
}

/* =========================================================
   CORPO DO MODAL
========================================================= */
.modal-body{
  padding:10px 4px 26px;
  overflow-y:auto;
  max-height:calc(92vh - 220px);
  scrollbar-gutter:stable;
}

.modal-body::-webkit-scrollbar{ width:8px }
.modal-body::-webkit-scrollbar-thumb{
  background:linear-gradient(180deg,#c7d2fe,#a5b4fc);
  border-radius:8px;
}

/* =========================================================
   TEXTOS DO MODAL
========================================================= */
.modal-body h3{
  margin:20px 0 10px;
  font-size:15px;
  font-weight:900;
  letter-spacing:.02em;
}

.modal-body p{
  margin:6px 0;
  font-size:14px;
  color:var(--muted);
}

.modal-body hr{
  border:none;
  height:1px;
  background:linear-gradient(90deg,transparent,var(--border),transparent);
  margin:22px 0;
}

/* =========================================================
   INGREDIENTES / IMPOSTOS
========================================================= */
.ing{
  display:grid;
  grid-template-columns:1fr auto auto;
  gap:14px;
  padding:10px;
  border:1px solid var(--border);
  border-radius:10px;
  font-size:14px;
  align-items:center;
  margin-bottom:8px;
  background:#fff;
}

.ing b{ font-weight:800 }
.ing small{ color:var(--muted) }

/* =========================================================
   PRECIFICA√á√ÉO
========================================================= */
.precificacao{
  background:#f8fafc;
  border:1px solid var(--border);
  border-radius:14px;
  padding:14px;
  margin:16px 0;
  box-shadow:var(--shadow-xs);
}

/* =========================================================
   INPUTS / SELECTS
========================================================= */
input, select, textarea{
  height:44px;
  border-radius:12px;
  border:1px solid var(--border);
  padding:0 14px;
  font-size:14px;
  font-weight:700;
  width:100%;
  background:#fff;
}

textarea{
  height:auto;
  min-height:70px;
  padding:14px;
  resize:vertical;
}

input:focus, select:focus, textarea:focus{
  outline:none;
  border-color:var(--primary);
  box-shadow:0 0 0 3px rgba(37,99,235,.18);
}

input[readonly]{
  background:#e5e7eb;
}

/* =========================================================
   BOT√ïES (PADR√ÉO √öNICO)
========================================================= */
button{
  font-family:Inter,sans-serif;
  border:none;
  cursor:pointer;
}

.btn-add{
  height:44px;
  padding:0 18px;
  border-radius:10px;
  background:#0f172a;
  color:#fff;
  font-size:12px;
  font-weight:800;
  letter-spacing:.08em;
  box-shadow:0 6px 16px rgba(15,23,42,.25);
  transition:.15s ease;
}

.btn-add:hover{
  transform:translateY(-1px);
  box-shadow:0 10px 26px rgba(15,23,42,.35);
}

.btn-icon{
  border-radius:8px;
  padding:6px 10px;
  font-size:13px;
  font-weight:800;
  box-shadow:0 2px 8px rgba(0,0,0,.15);
}

.btn-edit{
  background:#f1f5f9;
  color:#0f172a;
  border:1px solid var(--border);
}

.btn-delete{
  background:#fee2e2;
  color:#991b1b;
  border:1px solid #fecaca;
}

/* =========================================================
   FECHAR MODAL
========================================================= */
.close{
  position:absolute;
  top:14px;
  right:18px;
  font-size:26px;
  cursor:pointer;
  font-weight:900;
  color:#fff;
  z-index:10;
  text-shadow:0 4px 14px rgba(0,0,0,.7);
}

/* =========================================================
   RESPONSIVO
========================================================= */
@media(max-width:520px){
  .grid{
    grid-template-columns:repeat(3,1fr);
    gap:10px;
    padding:14px;
  }

  .card img{ height:110px }

  .modal{
    align-items:flex-end;
  }

  .modal-box{
    max-width:100%;
    height:92vh;
    border-radius:22px 22px 0 0;
  }

  .modal-header{
    grid-template-columns:1fr;
  }

  .modal-left{ height:180px }

  .modal-body{ padding:18px }

  .close{
    top:10px;
    right:14px;
    font-size:22px;
  }

  .ing{
    grid-template-columns:1fr auto;
    gap:8px;
  }

  .btn-add{ width:100% }
}
   
</style>
</head>

<body>
<div class="filters">
  <input id="filtroNome" type="text" placeholder="Buscar por nome do prato">
<select id="filtroTipo">
  <option value="">Todos os tipos</option>
</select>
</div>

<div id="cards" class="grid"></div>

<!-- MODAL -->
<div id="modal" class="modal" onclick="fechar()">
  <div class="modal-box" onclick="event.stopPropagation()">
    <span class="close" onclick="fechar()">‚úï</span>

    <div class="modal-header">
      <div class="modal-left">
        <img id="mFoto" class="modal-img">
      </div>

      <div class="modal-main">
        <div id="mHeader"></div>

        <!-- CONTE√öDO VAI PRAQUI -->
        <div id="mBody" class="modal-body"></div>
      </div>
    </div>
  </div>
</div>

<script>
const sb = supabase.createClient(
  "https://dxkszikemntfusfyrzos.supabase.co",
  "sb_publishable_NNFvdfSXgOdGGVcSbphbjQ_brC3_9ed"
);

const EMAILS_AUTORIZADOS_PRECO_IDEAL = [
  "leonardo_henrique1@hotmail.com",
  "souzanalbert58@gmail.com"
];

let usuarioEmailAtual = null;




   async function carregarUsuarioAuth() {
  const { data: sessionData } = await sb.auth.getSession();

  if (!sessionData.session) {
    console.warn("‚ùå Sess√£o n√£o encontrada no iframe");
    usuarioEmailAtual = null;
    return;
  }

  const { data: { user } } = await sb.auth.getUser();
  usuarioEmailAtual = user?.email || null;

  console.log("‚úÖ EMAIL AUTH NO IFRAME:", usuarioEmailAtual);
}

carregarUsuarioAuth();

sb.auth.onAuthStateChange((_event, session) => {
  usuarioEmailAtual = session?.user?.email || null;
});


/* =====================================================
   UTIL
===================================================== */
const moeda = v =>
  "R$ " + Number(v || 0).toLocaleString("pt-BR",{minimumFractionDigits:2});

/* =====================================================
   STATE
===================================================== */
let pratos = [];
let ingredientesBase = [];
let impostosCache = [];
let pratoAtual = null;
let filtroTipoSelecionado = "";


/* =====================================================
   LOAD BASE
===================================================== */
async function carregarIngredientesBase(){
  const { data, error } = await sb
    .from("produtos")
    .select("*")
    .order("nome");

  if(error) return alert("Erro ingredientes");
  ingredientesBase = data;
}

async function carregarPratos(){
  const { data, error } = await sb
    .from("buffet")
    .select("*")
    .order("created_at",{ascending:false});

  if(error) return alert("Erro pratos");
  pratos = data;
  renderLista();
}


async function calcularCMVPercentual(prato){
  if(!prato.preco_venda || prato.preco_venda <= 0) return null;

  const { data: itens } = await sb
    .from("buffet_itens")
    .select("custo_calculado")
    .eq("buffet_id", prato.id);

  const cmvBase = (itens || []).reduce(
    (s,i)=> s + Number(i.custo_calculado || 0), 0
  );

  const { data: impostos } = await sb
    .from("impostos")
    .select("modalidade, valor")
    .eq("buffet_id", prato.id);

  let totalImpostos = 0;

  (impostos || []).forEach(i=>{
    if(i.modalidade === "FIXO")
      totalImpostos += Number(i.valor);

if(i.modalidade === "PERCENTUAL")
  totalImpostos += (Number(prato.preco_venda || 0) * Number(i.valor)) / 100;
  });

  const cmvFinal = cmvBase + totalImpostos;

  return (cmvFinal / prato.preco_venda) * 100;
}

let cacheCMV = {};

async function carregarCMVCache(){
  cacheCMV = {};

  const { data: itens } = await sb
    .from("buffet_itens")
    .select("buffet_id, custo_calculado");

  const { data: impostos } = await sb
    .from("impostos")
    .select("buffet_id, modalidade, valor");

  // soma ingredientes
  (itens || []).forEach(i=>{
    cacheCMV[i.buffet_id] ??= { cmvBase:0, impostos:[] };
    cacheCMV[i.buffet_id].cmvBase += Number(i.custo_calculado || 0);
  });

  // agrupa impostos
  (impostos || []).forEach(i=>{
    cacheCMV[i.buffet_id] ??= { cmvBase:0, impostos:[] };
    cacheCMV[i.buffet_id].impostos.push(i);
  });
}








   
/* =====================================================
   LISTA
===================================================== */
function renderLista(){
  cards.innerHTML = "";

  const nomeFiltro = (filtroNome.value || "").toUpperCase().trim();
  const tipoFiltro = filtroTipo.value;

for(const p of pratos){

// if (p.ativo === false) continue;

    const nomeOk =
      !nomeFiltro || p.nome.toUpperCase().includes(nomeFiltro);
    const tipoOk =
      !tipoFiltro || p.tipo === tipoFiltro;

    if(!nomeOk || !tipoOk) continue;

    const dados = cacheCMV[p.id] || { cmvBase:0, impostos:[] };

    let totalImpostos = 0;
    dados.impostos.forEach(i=>{
      if(i.modalidade === "FIXO")
        totalImpostos += Number(i.valor);
if(i.modalidade === "PERCENTUAL")
  totalImpostos += (Number(p.preco_venda || 0) * Number(i.valor)) / 100;
    });

const custoBase = dados.cmvBase;
const custoTotal = dados.cmvBase + totalImpostos;

// CMV cl√°ssico (custo final / venda)
const cmvPerc =
  p.preco_venda ? (custoTotal / p.preco_venda) * 100 : null;

// üëâ NOVO: quanto os custos operacionais representam sobre o custo base
const custosSobreBasePerc =
  custoBase > 0 ? (totalImpostos / custoBase) * 100 : null;

const lucro =
  p.preco_venda ? p.preco_venda - custoTotal : null;

const margem =
  p.preco_venda ? (lucro / p.preco_venda) * 100 : null;

const c = document.createElement("div");
c.className = "card";
if (p.ativo === false) {
  c.style.opacity = "0.45";
  c.style.filter = "grayscale(1)";
}

    c.onclick = ()=>abrirModal(p);

c.innerHTML = `
  ${p.foto_url ? `<img src="${p.foto_url}">` : ``}
  <div class="card-body">

    <h3>${p.nome}</h3>
${p.descricao ? `
  <p style="
    font-size:13px;
    color:#64748b;
    line-height:1.3;
    margin:4px 0 8px;
    display:-webkit-box;
    -webkit-line-clamp:2;
    -webkit-box-orient:vertical;
    overflow:hidden;
  ">
    ${p.descricao}
  </p>
` : ``}

    <!-- LINHA 1 ‚Äî STATUS FINANCEIRO -->
    <div class="badges primary">
      <span class="badge">${p.tipo || "-"}</span>

${cmvPerc !== null ? `
  <span class="badge"
    style="
      background:${cmvPerc > 35 ? '#fee2e2' : '#dcfce7'};
      color:${cmvPerc > 35 ? '#991b1b' : '#166534'}">
    üìä CMV ${cmvPerc.toFixed(1)}%
  </span>
` : ``}

${custosSobreBasePerc !== null ? `
  <span class="badge"
    style="
      background:${custosSobreBasePerc > 100 ? '#fee2e2' : '#dcfce7'};
      color:${custosSobreBasePerc > 100 ? '#991b1b' : '#166534'}">
    ‚öô Custos/Base ${custosSobreBasePerc.toFixed(0)}%
  </span>
` : ``}

      ${margem !== null ? `
        <span class="badge"
          style="
            background:${margem < 30 ? '#fee2e2' : '#dcfce7'};
            color:${margem < 30 ? '#991b1b' : '#166534'}">
          üìà Margem ${margem.toFixed(1)}%
        </span>
      ` : ``}
    </div>

<!-- LINHA 2 ‚Äî CUSTOS -->
<div class="badges">
  <span class="badge">üßæ Custo ${moeda(custoBase)}</span>

  ${totalImpostos > 0
    ? `<span class="badge">‚öô Op. ${moeda(totalImpostos)}</span>`
    : ``}
</div>

    <!-- LINHA 3 ‚Äî RESULTADO -->
    <div class="badges secondary">
      ${p.preco_venda
        ? `<span class="badge">üí∞ Venda ${moeda(p.preco_venda)}</span>`
        : ``}

      ${lucro !== null ? `
        <span class="badge"
          style="
            background:${lucro < 0 ? '#fee2e2' : '#dcfce7'};
            color:${lucro < 0 ? '#991b1b' : '#166534'}">
          üü¢ Lucro ${moeda(lucro)}
        </span>
      ` : ``}
    </div>

  </div>
`;
cards.appendChild(c);
  } // fecha for
}   // fecha renderLista

/* =====================================================
   MODAL
===================================================== */
async function abrirModal(p){
  pratoAtual = p;
  modal.style.display = "flex";
  document.body.style.overflow = "hidden";
mFoto.src = p.foto_url || "https://placehold.co/600x400?text=Sem+Foto";  
  /* INGREDIENTES */
const { data: itens } = await sb
  .from("buffet_itens")
  .select(`
    id,
    nome,
    quantidade,
    unidade_uso,
    custo_unitario,
    custo_calculado,
    produto:produtos (
      energia_kcal,
      carboidratos,
      proteinas,
      gorduras_totais,
      fibra_alimentar,
      sodio_mg
    )
  `)
  .eq("buffet_id", p.id);

// ===============================
// CALCULO FICHA NUTRICIONAL
// ===============================
const nutri = {
  calorias: 0,
  carboidratos: 0,
  proteinas: 0,
  gorduras: 0,
  fibras: 0,
  sodio: 0
};

(itens || []).forEach(i => {
  const qtd = Number(i.quantidade || 0);
  const prod = i.produto;
  if (!prod) return;

  nutri.calorias     += Number(prod.energia_kcal || 0) * qtd;
  nutri.carboidratos += Number(prod.carboidratos || 0) * qtd;
  nutri.proteinas    += Number(prod.proteinas || 0) * qtd;
  nutri.gorduras     += Number(prod.gorduras_totais || 0) * qtd;
  nutri.fibras       += Number(prod.fibra_alimentar || 0) * qtd;
  nutri.sodio        += Number(prod.sodio_mg || 0) * qtd;
});


  const cmvBase = itens.reduce(
    (s,i)=>s + Number(i.custo_calculado||0),0
  );

  /* IMPOSTOS / CUSTOS */
  const { data: impostos } = await sb
    .from("impostos")
    .select("*")
    .eq("buffet_id", p.id);

  impostosCache = impostos || [];

  let totalImpostos = 0;
  impostosCache.forEach(i=>{
    if(i.modalidade==="FIXO") totalImpostos += Number(i.valor);
if(i.modalidade==="PERCENTUAL")
  totalImpostos += (Number(p.preco_venda || 0) * Number(i.valor)) / 100;;
  });

  const cmvFinal = cmvBase + totalImpostos;
  const precoVenda = Number(p.preco_venda||0);
  const lucro = precoVenda ? precoVenda - cmvFinal : 0;
  const margem = precoVenda ? (lucro/precoVenda)*100 : 0;

mHeader.innerHTML = `
<div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
  <h2 id="tituloPrato" style="margin:0">${p.nome}</h2>

  <button class="btn-icon btn-edit"
    title="Editar nome do prato"
    onclick="editarNomePrato()">
    ‚úèÔ∏è
  </button>
</div>
  <div class="badges primary">
    <span class="badge">${p.tipo || "-"}</span>

    <span class="badge" style="background:#dcfce7;color:#166534">
      üí∞ Venda ${moeda(precoVenda)}
    </span>

    <span class="badge" style="background:#eef2ff;color:#3730a3">
      üßæ Custo ${moeda(cmvFinal)}
    </span>

    <span class="badge" style="
      background:${margem < 30 ? '#fee2e2' : '#dcfce7'};
      color:${margem < 30 ? '#991b1b' : '#166534'}">
      üìà Margem ${margem.toFixed(1)}%
    </span>
  </div>
`;


mBody.innerHTML = `
<h3>Descri√ß√£o do prato (texto do card√°pio)</h3>

<textarea
  id="descricaoPrato"
  placeholder="Ex: Salm√£o grelhado com arroz japon√™s e molho teriyaki."
  style="
    width:100%;
    min-height:70px;
    padding:14px;
    border-radius:14px;
    border:1px solid var(--border);
    font-size:14px;
    font-family:Inter,sans-serif;
    resize:vertical;
  "
>${p.descricao || ""}</textarea>

<div style="margin:14px 0">
  <label style="font-weight:800;font-size:13px">
    STATUS DO PRATO
  </label>

  <select id="statusPrato" style="margin-top:6px">
    <option value="true">ATIVO</option>
    <option value="false">DESATIVADO</option>
  </select>
</div>

  <div style="margin:12px 0">
    <label style="font-weight:800;font-size:13px">
      FOTO DO PRATO
    </label>

    <input
      type="file"
      id="fotoPrato"
      accept="image/*"
      style="margin-top:6px"
    >
  </div>

  <p><b>CUSTO BASE:</b> ${moeda(cmvBase)}</p>
  <p><b>IMPOSTOS E CUSTOS OPERACIONAIS:</b> ${moeda(totalImpostos)}</p>
  <p><b>CUSTO FINAL:</b> ${moeda(cmvFinal)}</p>

  <hr>
  <h3>Tipo do prato</h3>

<select id="tipoPrato">
  <option value="">SELECIONE</option>
</select>

<hr>
<hr>

<h3>C√≥digo do Varejo (Varejo F√°cil)</h3>

<div class="precificacao">
  <label style="font-weight:800;font-size:13px">
    üè∑Ô∏è C√ìDIGO NO VAREJO F√ÅCIL
  </label>

  <input
    id="codigoVarejoInput"
    type="text"
    placeholder="Ex: 123456"
    value="${p.codigo_varejo || ""}"
    style="margin-top:8px"
  >

  <small style="color:var(--muted)">
    C√≥digo de integra√ß√£o com o sistema Varejo F√°cil.
  </small>
</div>

<h3>Pre√ßo ideal</h3>

<div class="precificacao">
  <label style="font-weight:800;font-size:13px">
    üí° PRE√áO IDEAL (R$)
  </label>

  <input
    id="precoIdealInput"
    type="number"
    step="0.01"
    placeholder="Ex: 29.90"
    value="${p.preco_ideal || ""}"
    style="margin-top:8px"
  >

  <small style="color:var(--muted)">
    Valor de refer√™ncia ideal (salva automaticamente).
  </small>
</div>

<h3>Precifica√ß√£o</h3>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
  <input id="markupPerc" type="number" step="0.01" placeholder="Markup (%)">
  <input id="precoVendaInput" type="number" step="0.01" placeholder="Pre√ßo de venda (R$)">
</div>

<p id="previewPreco" style="margin-top:8px;font-size:13px;font-weight:700;color:#166534"></p>


  <button class="btn-add" style="margin-top:10px"
    onclick="salvarPrecoVenda(${cmvFinal})">
    SALVAR PRE√áO DE VENDA
  </button>

${precoVenda ? `
  <p><b>Pre√ßo atual:</b> ${moeda(precoVenda)}</p>
  <p><b>Lucro:</b> ${moeda(lucro)}</p>
  <p><b>Margem:</b> ${margem.toFixed(2)}%</p>
` : ``}

${p.preco_ideal && precoVenda && precoVenda !== p.preco_ideal ? `
  <p style="
    margin-top:10px;
    padding:10px 14px;
    border-radius:12px;
    background:#fff7ed;
    border:1px solid #fed7aa;
    color:#9a3412;
    font-weight:800;
  ">
    ‚ö†Ô∏è Pre√ßo de venda diferente do pre√ßo sugerido
  </p>
` : ``}

${p.preco_ideal ? `
  <p><b>Pre√ßo ideal:</b> ${moeda(p.preco_ideal)}</p>
` : ``}



  <hr>

  <h3>Ingredientes</h3>
  ${itens.map(i=>`
    <div class="ing">
      <span>
        <b>${i.nome} ‚Äî ${moeda(i.custo_unitario)}</b><br>
        <small>${i.quantidade} ${i.unidade_uso}</small>
      </span>

      <strong>${moeda(i.custo_calculado)}</strong>

<div style="display:flex;gap:6px;align-items:center">
<button class="btn-icon btn-edit"
          onclick="editarIngrediente('${i.id}')">‚úèÔ∏è</button>
        <button class="btn-icon btn-delete"
          onclick="excluirIngrediente('${i.id}')">üóëÔ∏è</button>
      </div>
    </div>
  `).join("")}

  <div class="precificacao">
    <h3>Novo ingrediente</h3>

    <select id="ingProduto">
      <option value="">Selecione</option>
      ${ingredientesBase.map(i=>`
        <option value="${i.id}"
          data-custo="${i.valor}"
          data-unidade="${i.unidade_medida}">
          ${i.nome}
        </option>
      `).join("")}
    </select>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <input id="ingQtd" type="number" step="0.001" placeholder="Quantidade">
      <input id="ingUnidade" readonly placeholder="Unidade">
    </div>

<button id="btnSalvarIngrediente" class="btn-add" style="margin-top:10px"
  onclick="salvarIngrediente()">ADICIONAR INGREDIENTE</button>
  </div>

  <hr>

  <h3>Custos / Impostos</h3>
  ${impostosCache.map(i=>`
    <div class="ing">
      <span>
        <b>${i.descricao}</b><br>
        <small>${i.tipo} ‚Ä¢ ${i.modalidade === "PERCENTUAL" ? i.valor+"%" : moeda(i.valor)}</small>
      </span>
      <strong>
 ${i.modalidade==="PERCENTUAL"
  ? moeda((Number(p.preco_venda || 0) * i.valor) / 100)
  : moeda(i.valor)}
      </strong>
      <button class="btn-icon btn-delete"
        onclick="excluirImposto('${i.id}')">üóëÔ∏è</button>
    </div>
  `).join("")}

  <div class="precificacao">
    <h3>Novo custo / imposto</h3>

    <input id="impDesc" placeholder="Descri√ß√£o">

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      <select id="impTipo">
        <option value="IMPOSTO">IMPOSTO</option>
        <option value="CUSTO">CUSTO</option>
      </select>

      <select id="impModalidade">
        <option value="FIXO">VALOR FIXO</option>
        <option value="PERCENTUAL">PERCENTUAL (%)</option>
      </select>
    </div>

    <input id="impValor" type="number" step="0.01" placeholder="Valor">

    <button class="btn-add" style="margin-top:10px"
      onclick="salvarImposto()">ADICIONAR</button>
  </div>
<hr>
<hr>

<h3>Tabela Nutricional (por prato)</h3>

<div class="precificacao">
  <p>üî• Calorias: <b>${nutri.calorias.toFixed(1)} kcal</b></p>
  <p>ü•© Prote√≠nas: <b>${nutri.proteinas.toFixed(1)} g</b></p>
  <p>üçû Carboidratos: <b>${nutri.carboidratos.toFixed(1)} g</b></p>
  <p>üßà Gorduras: <b>${nutri.gorduras.toFixed(1)} g</b></p>
  <p>üåæ Fibras: <b>${nutri.fibras.toFixed(1)} g</b></p>
  <p>üßÇ S√≥dio: <b>${nutri.sodio.toFixed(1)} mg</b></p>
</div>

<h3>Modo de preparo</h3>

<textarea
  id="modoPreparo"
  placeholder="Descreva o modo de preparo do prato..."
  style="
    width:100%;
    min-height:120px;
    padding:14px;
    border-radius:14px;
    border:1px solid var(--border);
    font-size:14px;
    font-family:Inter,sans-serif;
    resize:vertical;
  "
>${p.modo_preparo || ""}</textarea>


  
`;



// üî• agora o select existe ‚Üí carrega os tipos
await carregarTipos();

// seta o tipo atual
const selectTipo = document.getElementById("tipoPrato");
if (selectTipo && p.tipo) {
  selectTipo.value = p.tipo;
}

// salva ao mudar
if (selectTipo) {
  selectTipo.onchange = async () => {
    const tipo = selectTipo.value;
    if (!tipo) return;

    await sb
      .from("buffet")
      .update({ tipo })
      .eq("id", pratoAtual.id);

    await carregarPratos();
    renderLista();
  };
}
setTimeout(() => {
  const selectTipo = document.getElementById("tipoPrato");
  if (!selectTipo) return;

  if (p.tipo) {
    selectTipo.value = p.tipo;
  }

  selectTipo.onchange = async () => {
    const tipo = selectTipo.value;
    if (!tipo) return;

    await sb
      .from("buffet")
      .update({ tipo })
      .eq("id", pratoAtual.id);

    await carregarPratos();
    renderLista();
  };
}, 0);
setTimeout(() => {
  const inputFoto = document.getElementById("fotoPrato");
  if (!inputFoto) return;

  inputFoto.onchange = async () => {
    const file = inputFoto.files[0];
    if (!file) return;

    const ext = file.name.split(".").pop();
    const fileName = `${pratoAtual.id}.${ext}`;

    const { error: uploadError } = await sb.storage
      .from("buffet")
      .upload(fileName, file, { upsert: true });

    if (uploadError) {
      alert("Erro ao enviar imagem");
      return;
    }

    const { data } = sb.storage
      .from("buffet")
      .getPublicUrl(fileName);

    const fotoUrl = data.publicUrl;

    await sb
      .from("buffet")
      .update({ foto_url: fotoUrl })
      .eq("id", pratoAtual.id);

    mFoto.src = fotoUrl;

    await carregarPratos();
    renderLista();
  };
}, 0);

  setTimeout(() => {
    const selectTipo = document.getElementById("tipoPrato");
    if (selectTipo && p.tipo) {
      selectTipo.value = p.tipo;
    }
  }, 0);
setTimeout(() => {
  const statusSelect = document.getElementById("statusPrato");
  if (!statusSelect) return;

  statusSelect.value = p.ativo === false ? "false" : "true";

  statusSelect.onchange = async () => {
    const ativo = statusSelect.value === "true";

    await sb
      .from("buffet")
      .update({ ativo })
      .eq("id", pratoAtual.id);

    await carregarPratos();
    renderLista();
  };
}, 0);
setTimeout(() => {
  const mp = document.getElementById("modoPreparo");
  if (!mp) return;

  const valorInicial = (p.modo_preparo || "").trim();

  mp.onblur = async () => {
    const textoAtual = mp.value.trim();

    // ‚ùå n√£o mudou ‚Üí n√£o salva
    if (textoAtual === valorInicial) return;

    await sb
      .from("buffet")
      .update({ modo_preparo: textoAtual })
      .eq("id", pratoAtual.id);
  };
}, 0);


setTimeout(() => {
  const desc = document.getElementById("descricaoPrato");
  if (!desc) return;

  const valorInicial = (p.descricao || "").trim();

  desc.onblur = async () => {
    const textoAtual = desc.value.trim();
    if (textoAtual === valorInicial) return;

    await sb
      .from("buffet")
      .update({ descricao: textoAtual })
      .eq("id", pratoAtual.id);

    await carregarPratos();
    renderLista();
  };
}, 0);

setTimeout(async () => {
  const input = document.getElementById("precoIdealInput");
  if (!input) return;

  const valorInicial = Number(p.preco_ideal || 0);

  // üîê busca o usu√°rio direto do Supabase (SEM race condition)
  const { data: { user } } = await sb.auth.getUser();
  const email = user?.email || null;

  console.log("üîê EMAIL NO MODAL:", email);

  const autorizado =
    email && EMAILS_AUTORIZADOS_PRECO_IDEAL.includes(email);

  if (!autorizado) {
    input.readOnly = true;
    input.style.opacity = "0.6";
    input.title =
      "Apenas usu√°rios autorizados podem alterar o pre√ßo sugerido";
    return;
  }

  // ‚úÖ autorizado ‚Üí salva autom√°tico
  input.onblur = async () => {
    const novoValor = Number(input.value || 0);

    if (novoValor === valorInicial) return;

    if (novoValor <= 0) {
      alert("Pre√ßo ideal inv√°lido");
      input.value = valorInicial || "";
      return;
    }

    await sb
      .from("buffet")
      .update({ preco_ideal: novoValor })
      .eq("id", pratoAtual.id);

    await carregarPratos();
  };
}, 0);

setTimeout(async () => {
  const input = document.getElementById("codigoVarejoInput");
  if (!input) return;

  const valorInicial = (p.codigo_varejo || "").trim();

  const { data: { user } } = await sb.auth.getUser();
  const email = user?.email || null;

  const autorizado =
    email && EMAILS_AUTORIZADOS_PRECO_IDEAL.includes(email);

  if (!autorizado) {
    input.readOnly = true;
    input.style.opacity = "0.6";
    input.title =
      "Apenas usu√°rios autorizados podem alterar o c√≥digo do varejo";
    return;
  }

  input.onblur = async () => {
    const novoValor = input.value.trim();
    if (novoValor === valorInicial) return;

    await sb
      .from("buffet")
      .update({ codigo_varejo: novoValor })
      .eq("id", pratoAtual.id);

    await carregarPratos();
    renderLista();
  };
}, 0);
setTimeout(() => {
  const mkInput = document.getElementById("markupPerc");
  const precoInput = document.getElementById("precoVendaInput");
  const preview = document.getElementById("previewPreco");

  function atualizarPorMarkup() {
    const mk = Number(mkInput.value || 0);
    if (mk <= 0) return;

    const preco = cmvFinal * (1 + mk / 100);
    precoInput.value = preco.toFixed(2);

    const lucro = preco - cmvFinal;
    const margem = (lucro / preco) * 100;

    preview.innerHTML = `
      Pre√ßo: <b>${moeda(preco)}</b> ‚Ä¢
      Lucro: <b>${moeda(lucro)}</b> ‚Ä¢
      Margem: <b>${margem.toFixed(1)}%</b>
    `;
  }

  function atualizarPorPreco() {
    const preco = Number(precoInput.value || 0);
    if (preco <= cmvFinal) return;

    const mk = ((preco - cmvFinal) / cmvFinal) * 100;
    mkInput.value = mk.toFixed(2);

    const lucro = preco - cmvFinal;
    const margem = (lucro / preco) * 100;

    preview.innerHTML = `
      Markup: <b>${mk.toFixed(1)}%</b> ‚Ä¢
      Lucro: <b>${moeda(lucro)}</b> ‚Ä¢
      Margem: <b>${margem.toFixed(1)}%</b>
    `;
  }

  mkInput.oninput = atualizarPorMarkup;
  precoInput.oninput = atualizarPorPreco;
}, 50);

} // ‚úÖ FECHA abrirModal(p)


/* =====================================================
   A√á√ïES
===================================================== */
async function salvarPrecoVenda(cmvFinal){
  const preco = Number(precoVendaInput.value || 0);
  if (preco <= cmvFinal) {
    alert("Pre√ßo inv√°lido");
    return;
  }

  await sb.from("buffet")
    .update({ preco_venda: preco })
    .eq("id", pratoAtual.id);

  await carregarPratos();
  abrirModal(pratos.find(p => p.id === pratoAtual.id));
}

async function salvarIngrediente(){
  const prodId = ingProduto.value;
  const qtd = Number(ingQtd.value||0);
  if(!prodId || qtd<=0) return;

  const prod = ingredientesBase.find(p => p.id === prodId);
  const custoUnit = Number(prod.valor);

  await sb.from("buffet_itens").insert({
    buffet_id: pratoAtual.id,
    produto_id: prod.id,
    nome: prod.nome,
    quantidade: qtd,
    unidade_uso: prod.unidade_medida,
    custo_unitario: custoUnit,
    custo_calculado: custoUnit * qtd
  });

  await carregarCMVCache();

  const { data: pratoNovo } = await sb
    .from("buffet")
    .select("*")
    .eq("id", pratoAtual.id)
    .single();

  abrirModal(pratoNovo);
}

async function excluirIngrediente(itemId){
  if(!confirm("Excluir este ingrediente?")) return;

  await sb
    .from("buffet_itens")
    .delete()
    .eq("id", itemId);

  await carregarCMVCache();

  const { data: pratoNovo } = await sb
    .from("buffet")
    .select("*")
    .eq("id", pratoAtual.id)
    .single();

  abrirModal(pratoNovo);
}

async function salvarImposto(){
  const desc = impDesc.value.trim();
  const tipo = impTipo.value;
  const modalidade = impModalidade.value;
  const valor = Number(impValor.value||0);

  if(!desc || valor<=0) return;

  await sb.from("impostos").insert({
    buffet_id: pratoAtual.id,
    descricao: desc,
    tipo,
    modalidade,
    valor
  });

  abrirModal(pratoAtual);
}

async function excluirImposto(id){
  await sb.from("impostos").delete().eq("id",id);
  abrirModal(pratoAtual);
}
/* =====================================================
   AUTO UNIDADE
===================================================== */
document.addEventListener("change", e => {
  if (e.target.id === "ingProduto") {
    const opt = e.target.selectedOptions[0];
    ingUnidade.value = opt?.dataset?.unidade || "";
  }
});


function fechar(){
  modal.style.display="none";
  document.body.style.overflow="";
}


async function editarIngrediente(itemId){
  const { data, error } = await sb
    .from("buffet_itens")
    .select("*")
    .eq("id", itemId)
    .single();

  if(error){
    alert("Erro ao carregar ingrediente");
    return;
  }

  // preenche formul√°rio
  ingProduto.value = data.produto_id;
  ingQtd.value = data.quantidade;
  ingUnidade.value = data.unidade_uso;

const btn = document.getElementById("btnSalvarIngrediente");  btn.innerText = "ATUALIZAR INGREDIENTE";

  btn.onclick = async () => {
    const qtd = Number(ingQtd.value || 0);
    if(qtd <= 0) return alert("Quantidade inv√°lida");

    const prod = ingredientesBase.find(p => p.id === ingProduto.value);
    const custoUnit = Number(prod.valor);

await sb
  .from("buffet_itens")
  .update({
    quantidade: qtd,
    custo_unitario: custoUnit,
    custo_calculado: custoUnit * qtd
  })
  .eq("id", itemId);

// üîÅ atualiza cache de CMV
await carregarCMVCache();

// üîÑ recarrega o prato do banco (pra n√£o usar objeto velho)
const { data: pratoNovo } = await sb
  .from("buffet")
  .select("*")
  .eq("id", pratoAtual.id)
  .single();

btn.innerText = "ADICIONAR INGREDIENTE";
btn.onclick = salvarIngrediente;

ingProduto.value = "";
ingQtd.value = "";
ingUnidade.value = "";

// üîÅ reabre com dados novos
abrirModal(pratoNovo);
  };
}
filtroNome.addEventListener("input", () => {
  renderLista();
});

filtroTipo.addEventListener("change", () => {
  filtroTipoSelecionado = filtroTipo.value;   // salva o estado do filtro
  renderLista();
});


async function carregarTipos(){
  const { data, error } = await sb
    .from("buffet")
    .select("tipo");

  if(error){
    console.error("Erro ao buscar tipos:", error);
    return;
  }

  const tiposUnicos = [...new Set(
    (data || [])
      .map(i => (i.tipo || "").trim())
      .filter(Boolean)
  )].sort();

  // filtro principal
  if (window.filtroTipo) {
    filtroTipo.innerHTML = `<option value="">Todos os tipos</option>` +
      tiposUnicos.map(t => `<option value="${t}">${t}</option>`).join("");

    // üîÅ mant√©m o filtro selecionado visualmente
    if (filtroTipoSelecionado) {
      filtroTipo.value = filtroTipoSelecionado;
    }
  }

  // select do modal
  const selectModal = document.getElementById("tipoPrato");
  if (selectModal) {
    selectModal.innerHTML = `
      <option value="">SELECIONE</option>
      ${tiposUnicos.map(t => `<option value="${t}">${t}</option>`).join("")}
    `;
  }
}
   (async ()=>{
  await carregarIngredientesBase();
  await carregarPratos();
  await carregarCMVCache();
  await carregarTipos();   // üëà ADICIONA ISSO
  renderLista();
})();

async function editarNomePrato(){
  const h2 = document.getElementById("tituloPrato");
  if (!h2 || !pratoAtual?.id) return;

  const nomeAtual = h2.innerText.trim();

  const novoNome = prompt("Novo nome do prato:", nomeAtual);
  if (!novoNome || novoNome.trim() === nomeAtual) return;

  const nomeFinal = novoNome.trim().toUpperCase();

  const { error } = await sb
    .from("buffet")
    .update({ nome: nomeFinal })
    .eq("id", pratoAtual.id);

  if (error) {
    alert("Erro ao salvar o nome");
    return;
  }

  // üîÑ atualiza estado local
  pratoAtual.nome = nomeFinal;

  // atualiza o header do modal
  h2.innerText = nomeFinal;

  // atualiza lista de cards
  await carregarPratos();
  renderLista();
}

   
</script>



</body>
</html>
