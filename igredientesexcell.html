<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Ingredientes ‚Ä¢ Excel de Custos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --bg:#0f172a;
  --grid:#1e293b;
  --card:#020617;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --accent:#22c55e;
  --danger:#ef4444;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,sans-serif;background:var(--bg);color:var(--text)}

.header{
  display:flex; flex-wrap:wrap; gap:10px;
  align-items:center; padding:12px 16px;
  background:#020617; border-bottom:1px solid var(--grid);
}
.header h1{margin:0;font-size:18px;font-weight:900}

.search{
  background:#020617; border:1px solid var(--grid); color:var(--text);
  padding:6px 10px; border-radius:8px; font-weight:700;
}

.table-wrap{overflow:auto;height:calc(100vh - 64px)}
table{border-collapse:collapse;width:100%;min-width:1200px;font-size:13px}
thead th{position:sticky;top:0;background:#020617;z-index:2}
th,td{border:1px solid var(--grid);padding:8px 10px;white-space:nowrap}
tbody tr:hover{background:#020617}

input, select, textarea{
  background:#020617;border:1px solid #1e293b;color:#e5e7eb;
  padding:6px 8px;border-radius:6px;font-weight:700; width:100%;
}
input:focus, select:focus, textarea:focus{outline:none;border-color:#22c55e}
textarea{resize:vertical; min-height:36px}
</style>
</head>

<body>
<div class="header">
  <h1>üßæ Ingredientes ‚Ä¢ Base de Produtos</h1>
  <input id="busca" class="search" placeholder="Buscar ingrediente...">
</div>

<div class="table-wrap">
<table id="tabela">
<thead>
<tr>
  <th>Nome</th>
  <th>Descri√ß√£o</th>
  <th>Unidade</th>
  <th>Custo unit√°rio (R$)</th>
  <th>Rendimento %</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<script>
const sb = supabase.createClient(
  "https://dxkszikemntfusfyrzos.supabase.co",
  "sb_publishable_NNFvdfSXgOdGGVcSbphbjQ_brC3_9ed"
);

let produtos = [];

async function carregar(){
  const { data, error } = await sb.from("produtos").select("*").order("nome");
  if(error){ alert("Erro ao carregar produtos: " + error.message); return; }
  produtos = data || [];
  render();
}

function render(){
  const tbody = document.querySelector("#tabela tbody");
  tbody.innerHTML = "";

  const busca = (document.getElementById("busca").value || "").toLowerCase().trim();

  produtos
    .filter(p => !busca || (p.nome || "").toLowerCase().includes(busca))
    .forEach(p=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>
          <input value="${p.nome||""}" 
                 onchange="salvar('${p.id}','nome',this.value)">
        </td>

        <td>
          <textarea onchange="salvar('${p.id}','descricao',this.value)">${p.descricao||""}</textarea>
        </td>

        <td>
          <select onchange="salvar('${p.id}','unidade_medida',this.value)">
            ${["KG","G","L","ML","UN"].map(u => 
              `<option value="${u}" ${p.unidade_medida===u?'selected':''}>${u}</option>`
            ).join("")}
          </select>
        </td>

        <td>
          <input type="number" step="0.0001" value="${Number(p.valor||0)}"
                 onchange="salvar('${p.id}','valor',this.value)">
        </td>

        <td>
          <input type="number" step="0.01" value="${Number(p.rendimento_percentual||100)}"
                 onchange="salvar('${p.id}','rendimento_percentual',this.value)">
        </td>
      `;
      tbody.appendChild(tr);
    });
}

async function salvar(id, campo, valor){
  const obj = {};
  obj[campo] = valor;

  const { error } = await sb.from("produtos").update(obj).eq("id", id);
  if(error){
    alert("Erro ao salvar: " + error.message);
  }
}

document.getElementById("busca").oninput = render;

carregar();
</script>
</body>
</html>
