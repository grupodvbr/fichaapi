<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CardÃ¡pio Digital â€¢ Premium</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* === (CSS IGUAL AO SEU â€“ MANTIDO) === */
:root{
  --bg:#0b0b0c; --card:#111113; --text:#fff; --muted:#a1a1aa;
  --gold:#d4af37; --gold-soft:rgba(212,175,55,.25);
  --border:#1f1f22; --radius:18px; --shadow:0 20px 60px rgba(0,0,0,.6);
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter;background:linear-gradient(180deg,#000,#0b0b0c,#000);color:#fff;overflow-y:scroll}
body::-webkit-scrollbar{width:0;height:0}
.top{position:sticky;top:0;z-index:10;padding:14px;background:rgba(0,0,0,.85);backdrop-filter:blur(8px)}
.search{width:100%;height:48px;border-radius:999px;border:1px solid var(--border);background:#0f0f12;color:#fff;padding:0 18px;font-weight:700}
.cats{display:flex;gap:10px;margin-top:10px;overflow-x:auto}
.cats::-webkit-scrollbar{height:0}
.cat{padding:10px 14px;border-radius:999px;border:1px solid var(--border);background:#0f0f12;color:#fff;font-weight:800;font-size:12px;cursor:pointer}
.cat.active,.cat:hover{border-color:var(--gold);color:var(--gold)}
.grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;padding:12px 12px 80px}
.card{background:#0f0f12;border:1px solid var(--border);border-radius:18px;overflow:hidden;cursor:pointer}
.thumb{width:100%;aspect-ratio:1/1;object-fit:cover}
.body{padding:12px}
.name{font-weight:900;font-size:14px}
.desc{font-size:12px;color:#9ca3af;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.price{margin-top:6px;font-weight:900;color:var(--gold)}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:flex-end}
.modal.open{display:flex}
.modal-box{width:100%;max-width:720px;background:#000;border-radius:22px 22px 0 0;overflow:hidden}
.modal-img{width:100%;height:260px;object-fit:cover}
.modal-body{padding:18px}
.close{position:absolute;right:16px;top:10px;font-weight:900;cursor:pointer}
@media(min-width:700px){.grid{grid-template-columns:repeat(3,1fr)}}
@media(min-width:1024px){.grid{grid-template-columns:repeat(4,1fr)}}
</style>
</head>

<body>

<div class="top">
  <input id="search" class="search" placeholder="Buscar no cardÃ¡pio..." />
  <div id="cats" class="cats"></div>
</div>

<div id="grid" class="grid"></div>

<div id="modal" class="modal" onclick="closeModal()">
  <div class="modal-box" onclick="event.stopPropagation()">
    <span class="close" onclick="closeModal()">âœ•</span>
    <img id="mImg" class="modal-img" />
    <div class="modal-body">
      <div id="mName" class="modal-title"></div>
      <div id="mDesc" class="modal-desc"></div>
      <div id="mPrice" class="modal-price"></div>
    </div>
  </div>
</div>

<script>
const sb = supabase.createClient(
  "https://dxkszikemntfusfyrzos.supabase.co",
  "sb_publishable_NNFvdfSXgOdGGVcSbphbjQ_brC3_9ed"
);

const CATS = ["", "PRATO PRINCIPAL","ENTRADA","SOBREMESA","DRINK","SUSHI","ACOMPANHAMENTO"];
let cache = JSON.parse(localStorage.getItem("cardapio_cache") || "[]");
let catAtiva = "";
let termo = "";
let page = 0;
const PAGE_SIZE = 10;
let carregando = false;

const grid = document.getElementById("grid");
const cats = document.getElementById("cats");

function moeda(v){ return "R$ " + Number(v||0).toLocaleString("pt-BR",{minimumFractionDigits:2}); }

function renderCats(){
  cats.innerHTML = ["TODOS",...CATS.filter(Boolean)].map(c=>`
    <button class="cat ${c===catAtiva||(!c&&catAtiva==="" )?'active':''}"
      data-key="${c}">
      ${c || "TODOS"}
    </button>
  `).join("");

  // long-press 20s no TODOS
  const btnTodos = cats.querySelector('[data-key=""]');
  let t=null;
  btnTodos.onmousedown = btnTodos.ontouchstart = () => {
    t = setTimeout(async ()=>{
      localStorage.removeItem("cardapio_cache");
      cache = [];
      await fetchAll();
      resetAndRender();
      alert("ðŸ”„ CardÃ¡pio atualizado do servidor.");
    }, 20000);
  };
  btnTodos.onmouseup = btnTodos.ontouchend = () => clearTimeout(t);

  cats.querySelectorAll(".cat").forEach(btn=>{
    btn.onclick = ()=>{
      catAtiva = btn.dataset.key || "";
      resetAndRender();
      renderCats();
    };
  });
}

async function fetchAll(){
  if (carregando) return;
  carregando = true;

  const { data, error } = await sb
    .from("buffet")
    .select("id, nome, descricao, preco_venda, foto_url, tipo, ativo")
    .eq("ativo", true)
    .order("created_at", { ascending:false });

  if (error) return console.error(error);

  const map = {};
  [...cache, ...(data||[])].forEach(p => map[p.id] = p);
  cache = Object.values(map);

  localStorage.setItem("cardapio_cache", JSON.stringify(cache));
  carregando = false;
}

function resetAndRender(){
  page = 0;
  grid.innerHTML = "";
  loadMore();
}

function loadMore(){
  const base = cache
    .filter(p => !catAtiva || p.tipo === catAtiva)
    .filter(p => !termo || p.nome.toLowerCase().includes(termo.toLowerCase()));

  const slice = base.slice(page*PAGE_SIZE, page*PAGE_SIZE + PAGE_SIZE);

  slice.forEach(p=>{
    const d = document.createElement("div");
    d.className="card";
    d.onclick=()=>openModal(p);
    d.innerHTML = `
      <img class="thumb" src="${p.foto_url||""}">
      <div class="body">
        <div class="name">${p.nome}</div>
        <div class="desc">${p.descricao||""}</div>
        <div class="price">${moeda(p.preco_venda)}</div>
      </div>`;
    grid.appendChild(d);
  });

  if (slice.length) page++;
}

function openModal(p){
  mImg.src=p.foto_url||""; mName.textContent=p.nome;
  mDesc.textContent=p.descricao||""; mPrice.textContent=moeda(p.preco_venda);
  modal.classList.add("open");
}
function closeModal(){ modal.classList.remove("open"); }

window.addEventListener("scroll", ()=>{
  if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 600) {
    loadMore();
  }
});

search.oninput = ()=>{
  termo = search.value.trim();
  resetAndRender();
};

(async ()=>{
  if (!cache.length) await fetchAll();
  renderCats();
  resetAndRender();
})();
</script>
</body>
</html>
