<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Cadastro de Ingredientes â€¢ CMV</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --primary:#14b8a6;
  --primary-dark:#0f766e;
  --bg:#f1f5f9;
  --card:#ffffff;
}

*{box-sizing:border-box}

body{
  margin:0;
  padding:24px;
  background:var(--bg);
  font-family:Inter,sans-serif;
}

.container{
  max-width:900px;
  margin:auto;
  background:var(--card);
  border-radius:24px;
  padding:28px;
  box-shadow:0 20px 40px rgba(0,0,0,.08);
}

h1{margin-bottom:20px}

label{
  font-size:13px;
  font-weight:800;
  display:block;
  margin-top:14px;
}

input,select,button{
  width:100%;
  padding:14px 16px;
  border-radius:16px;
  border:1px solid #cbd5e1;
  margin-top:6px;
}

button{
  background:linear-gradient(180deg,var(--primary),var(--primary-dark));
  color:#fff;
  font-weight:800;
  border:none;
  cursor:pointer;
  margin-top:22px;
}

.grid{
  display:grid;
  grid-template-columns:1fr 1fr 1fr 1fr auto;
  gap:10px;
  margin-top:10px;
}

.var{
  background:#f8fafc;
  padding:14px;
  border-radius:14px;
  display:flex;
  justify-content:space-between;
  margin-top:8px;
  font-weight:700;
}
</style>
</head>

<body>

<div class="container">
<h1>ðŸ“¦ Cadastro de Ingredientes</h1>

<label>Nome</label>
<input id="nome">

<label>DescriÃ§Ã£o</label>
<input id="descricao">

<label>Unidade de Medida</label>
<select id="unidade">
  <option>UN</option>
  <option>KG</option>
  <option>G</option>
  <option>L</option>
  <option>ML</option>
</select>

<label>Valor</label>
<input id="valor" inputmode="decimal" placeholder="R$ 0,00">

<label>Rendimento (%)</label>
<input id="rendimento" inputmode="numeric" value="100">

<button onclick="salvarProduto()">Salvar Produto</button>

<hr style="margin:30px 0">

<h2>âž• VariaÃ§Ãµes</h2>

<div class="grid">
  <select id="vUnidade">
    <option>UN</option>
    <option>KG</option>
    <option>G</option>
    <option>L</option>
    <option>ML</option>
  </select>

  <input id="vValor" inputmode="decimal" placeholder="R$ 0,00">
  <input id="vRendimento" inputmode="numeric" value="100">
  <button onclick="addVariacao()">+</button>
</div>

<div id="lista"></div>
</div>

<script>
const sb = supabase.createClient(
  "https://dxkszikemntfusfyrzos.supabase.co",
  "sb_publishable_NNFvdfSXgOdGGVcSbphbjQ_brC3_9ed"
);

let produtoId = null;
let variacoes = [];

/* ===== MÃSCARAS ===== */
function moedaMask(el){
  el.addEventListener("input",()=>{
    let v = el.value.replace(/\D/g,"");
    v = (Number(v)/100).toFixed(2);
    el.value = "R$ " + v.replace(".",",");
  });
}

function numero(el){
  el.addEventListener("input",()=>{
    el.value = el.value.replace(/\D/g,"");
  });
}

moedaMask(valor);
moedaMask(vValor);
numero(rendimento);
numero(vRendimento);

/* ===== SALVAR PRODUTO ===== */
async function salvarProduto(){
  const data = {
    nome: nome.value,
    descricao: descricao.value,
    unidade_medida: unidade.value,
    valor: Number(valor.value.replace(/\D/g,""))/100,
    rendimento_percentual: Number(rendimento.value)
  };

  const { data:res, error } = await sb
    .from("produtos")
    .insert(data)
    .select()
    .single();

  if(error){ alert(error.message); return; }

  produtoId = res.id;
  alert("Produto salvo! Agora adicione variaÃ§Ãµes.");
}

/* ===== VARIAÃ‡Ã•ES ===== */
async function addVariacao(){
  if(!produtoId){ alert("Salve o produto primeiro"); return; }

  const payload = {
    produto_id: produtoId,
    unidade_medida: vUnidade.value,
    valor: Number(vValor.value.replace(/\D/g,""))/100,
    rendimento_percentual: Number(vRendimento.value)
  };

  const { error } = await sb
    .from("produto_variacoes")
    .insert(payload);

  if(error){ alert(error.message); return; }

  variacoes.push(payload);
  render();
}

function render(){
  lista.innerHTML = variacoes.map(v=>`
    <div class="var">
      ${v.unidade_medida} â€¢ R$ ${v.valor.toFixed(2)} â€¢ ${v.rendimento_percentual}%
    </div>
  `).join("");
}
</script>

</body>
</html>
