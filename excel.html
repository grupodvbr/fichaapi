<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>CMV ‚Ä¢ Excel de Precifica√ß√£o</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --bg:#0f172a;
  --grid:#1e293b;
  --card:#020617;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --accent:#22c55e;
  --danger:#ef4444;
}

*{box-sizing:border-box}
body{margin:0;font-family:Inter,sans-serif;background:var(--bg);color:var(--text)}

h1{
  padding:18px 22px;
  margin:0;
  font-size:18px;
  background:#020617;
  border-bottom:1px solid var(--grid);
}

.table-wrap{overflow:auto;height:calc(100vh - 60px)}
table{border-collapse:collapse;width:100%;min-width:1300px;font-size:13px}
thead th{position:sticky;top:0;background:#020617;z-index:2}
th,td{border:1px solid var(--grid);padding:8px 10px;white-space:nowrap}
tbody tr:hover{background:#020617;cursor:pointer}

input{
  width:80px;background:#020617;border:1px solid #1e293b;color:#e5e7eb;
  padding:4px 6px;border-radius:6px;font-weight:700
}
input:focus{outline:none;border-color:#22c55e}

.bad{color:#ef4444;font-weight:800}
.good{color:#22c55e;font-weight:800}

/* MODAL */
.modal{
  position:fixed; inset:0; background:rgba(0,0,0,.7);
  display:none; align-items:center; justify-content:center;
  backdrop-filter: blur(6px);
}
.modal-box{
  position:relative;
  background:#020617;
  border-radius:22px;
  max-width:1100px; width:92vw; max-height:92vh;
  overflow:auto; 
  border:1px solid #1e293b;
  box-shadow:0 30px 80px rgba(0,0,0,.6);
}
/* scrollbar invis√≠vel */
.modal-box::-webkit-scrollbar{ width:0; height:0 }
.modal-box{ scrollbar-width:none }

.modal-header{
  display:grid; grid-template-columns:360px 1fr; gap:18px;
  padding:18px;
}
.modal-header img{
  width:100%; height:100%; min-height:220px;
  object-fit:cover; border-radius:16px;
  box-shadow:0 12px 40px rgba(0,0,0,.6);
}
.modal-body{ padding:0 18px 18px }

.ing{
  display:grid; grid-template-columns:1fr auto; gap:10px;
  padding:10px 0; border-bottom:1px dashed #1e293b;
}

.close{
  position:absolute; top:14px; right:16px;
  cursor:pointer; font-weight:900; font-size:22px;
  background:#020617; border:1px solid #1e293b;
  padding:6px 10px; border-radius:10px;
}
.close:hover{ background:#0b1220 }
</style>
</head>

<body>
<h1>üìä Excel de Precifica√ß√£o ‚Ä¢ CMV</h1>

<div class="table-wrap">
<table id="tabela">
<thead>
<tr>
  <th>Prato</th>
  <th>Tipo</th>
  <th>Custo Base</th>
  <th>Custos</th>
  <th>Custo Final</th>
  <th>Markup %</th>
  <th>Pre√ßo (R$)</th>
  <th>CMV %</th>
  <th>Lucro</th>
  <th>Margem %</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<div class="modal" id="modal" onclick="fechar()">
  <div class="modal-box" onclick="event.stopPropagation()">
    <span class="close" onclick="fechar()">‚úï</span>
    <div class="modal-header" id="modalHeader"></div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<script>
const sb = supabase.createClient(
  "https://dxkszikemntfusfyrzos.supabase.co",
  "sb_publishable_NNFvdfSXgOdGGVcSbphbjQ_brC3_9ed"
);

const moeda = v => "R$ " + Number(v||0).toLocaleString("pt-BR",{minimumFractionDigits:2});

let cacheCMV = {};
let pratos = [];

async function carregarCache(){
  cacheCMV = {};
  const { data: itens } = await sb.from("buffet_itens").select("buffet_id, custo_calculado, nome, quantidade, unidade_uso");
  const { data: impostos } = await sb.from("impostos").select("buffet_id, modalidade, valor");

  (itens||[]).forEach(i=>{
    cacheCMV[i.buffet_id] ??= { base:0, impostos:[], itens:[] };
    cacheCMV[i.buffet_id].base += Number(i.custo_calculado||0);
    cacheCMV[i.buffet_id].itens.push(i);
  });

  (impostos||[]).forEach(i=>{
    cacheCMV[i.buffet_id] ??= { base:0, impostos:[], itens:[] };
    cacheCMV[i.buffet_id].impostos.push(i);
  });
}

async function carregar(){
  await carregarCache();
  const { data } = await sb.from("buffet").select("*").order("nome");
  pratos = data || [];
  render();
}

function render(){
  const tbody = document.querySelector("#tabela tbody");
  tbody.innerHTML = "";

  pratos.forEach(p=>{
    const d = cacheCMV[p.id] || { base:0, impostos:[], itens:[] };
    let imp = 0;
    d.impostos.forEach(i=>{
      if(i.modalidade==="FIXO") imp+=Number(i.valor);
      if(i.modalidade==="PERCENTUAL") imp+=(d.base*i.valor)/100;
    });

    const custoFinal = d.base + imp;
    const preco = Number(p.preco_venda||0);
    const lucro = preco - custoFinal;
    const cmv = preco ? (custoFinal/preco)*100 : 0;
    const margem = preco ? (lucro/preco)*100 : 0;

    const tr = document.createElement("tr");
    tr.onclick = ()=>abrirModal(p, d, custoFinal, cmv, lucro, margem);

    tr.innerHTML = `
      <td>${p.nome}</td>
      <td>${p.tipo||"-"}</td>
      <td>${moeda(d.base)}</td>
      <td>${moeda(imp)}</td>
      <td>${moeda(custoFinal)}</td>
      <td>
        <input type="number" step="0.01" placeholder="%"
          onclick="event.stopPropagation()"
          onblur="precificarPerc(this, ${custoFinal}, '${p.id}')">
      </td>
      <td>
        <input type="number" step="0.01" placeholder="R$"
          onclick="event.stopPropagation()"
          onblur="precificarValor(this, ${custoFinal}, '${p.id}')"
          value="${preco?preco.toFixed(2):''}">
      </td>
      <td class="${cmv>35?'bad':'good'}">${cmv.toFixed(1)}%</td>
      <td class="${lucro<0?'bad':'good'}">${moeda(lucro)}</td>
      <td class="${margem<30?'bad':'good'}">${margem.toFixed(1)}%</td>
    `;
    tbody.appendChild(tr);
  });
}

async function precificarPerc(input, custo, id){
  const mk = Number(input.value||0);
  if(mk<=0) return;
  const preco = custo*(1+mk/100);
  await sb.from("buffet").update({ preco_venda: preco }).eq("id", id);
  carregar();
}

async function precificarValor(input, custo, id){
  const preco = Number(input.value||0);
  if(preco<=custo) return alert("Pre√ßo inv√°lido");
  await sb.from("buffet").update({ preco_venda: preco }).eq("id", id);
  carregar();
}

function abrirModal(p, d, custo, cmv, lucro, margem){
  modal.style.display="flex";

  modalHeader.innerHTML = `
    <img src="${p.foto_url||'https://placehold.co/600x400?text=Sem+Foto'}">
    <div>
      <h2>${p.nome}</h2>
      <p style="color:var(--muted)">${p.tipo||""}</p>
      <p><b>Venda:</b> ${moeda(p.preco_venda)}</p>
      <p><b>Custo Final:</b> ${moeda(custo)}</p>
      <p><b>Lucro:</b> ${moeda(lucro)}</p>
      <p><b>Margem:</b> ${margem.toFixed(1)}%</p>
    </div>
  `;

  modalBody.innerHTML = `
    <h3>Ingredientes</h3>
    ${d.itens.map(i=>`
      <div class="ing">
        <span>${i.nome} (${i.quantidade} ${i.unidade_uso})</span>
        <b>${moeda(i.custo_calculado)}</b>
      </div>
    `).join("")}

    <h3 style="margin-top:16px">Descri√ß√£o</h3>
    <p>${p.descricao||"-"}</p>

    <h3>Modo de preparo</h3>
    <p>${p.modo_preparo||"-"}</p>
  `;
}

function fechar(){ modal.style.display="none"; }
carregar();
</script>
</body>
</html>
