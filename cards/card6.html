<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Vendas por Hora ‚Ä¢ Fiscal</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --primary:#14b8a6;
  --primary-dark:#0f766e;
  --card:#ffffff;
  --muted:#64748b;
  --bg:#f8fafc;
}
*{box-sizing:border-box}
html,body{
  margin:0;
  height:100%;
  font-family:Inter,Arial,sans-serif;
}
.card{
  height:100%;
  background:var(--card);
  border-radius:22px;
  padding:20px;
  box-shadow:0 18px 40px rgba(0,0,0,.08);
  display:flex;
  flex-direction:column;
}
.header{
  font-weight:800;
  font-size:15px;
  margin-bottom:10px;
}
.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
}
.grid input{
  padding:10px;
  border-radius:12px;
  border:1px solid #cbd5e1;
  font-size:12px;
}
.kpi{
  margin-top:14px;
  background:var(--bg);
  border-radius:18px;
  padding:16px;
  text-align:center;
}
.kpi span{
  font-size:13px;
  color:var(--muted);
}
.kpi strong{
  display:block;
  font-size:28px;
  font-weight:800;
}
.chart-wrap{
  margin-top:18px;
  flex:1;
}
.footer{
  margin-top:12px;
  font-size:12px;
  color:var(--muted);
  text-align:center;
}
</style>
</head>

<body>

<div class="card">

  <div class="header">‚è∞ Vendas por hora (Fiscal)</div>

  <div class="grid">
    <input type="date" id="de">
    <input type="date" id="ate">
  </div>

  <div class="kpi">
    <span>Quantidade total no per√≠odo</span>
    <strong id="totalQtd">‚Äî</strong>
  </div>

  <div class="chart-wrap">
    <canvas id="grafico"></canvas>
  </div>

  <div class="footer">
    Fonte: Cupons fiscais ‚Ä¢ Varejo F√°cil
  </div>

</div>

<script>
const de = document.getElementById("de");
const ate = document.getElementById("ate");
const totalQtd = document.getElementById("totalQtd");

let chart;

/* Datas padr√£o */
(() => {
  const hoje = new Date();
  de.value = new Date(hoje.getFullYear(), hoje.getMonth(), 1).toISOString().slice(0,10);
  ate.value = hoje.toISOString().slice(0,10);
})();

/* Produto opcional via URL */
const params = new URLSearchParams(window.location.search);
const produtoId = params.get("produtoId");

/* CONSULTA */
async function consultar() {

  const url =
    `/api/vendas-por-hora?de=${de.value}&ate=${ate.value}` +
    (produtoId ? `&produtoId=${produtoId}` : "");

  console.log("‚û°Ô∏è Consultando:", url);

  const r = await fetch(url);
  const j = await r.json();

  console.log("üì¶ Resposta:", j);

  const horas = j.porHora.map(h => `${String(h.hora).padStart(2,"0")}h`);
  const valores = j.porHora.map(h => h.quantidade);

  const soma = valores.reduce((a,b) => a+b, 0);
  totalQtd.textContent = soma.toFixed(3);

  renderGrafico(horas, valores);
}

/* GR√ÅFICO */
function renderGrafico(labels, data){

  if (chart) chart.destroy();

  chart = new Chart(document.getElementById("grafico"), {
    type: "bar",
    data: {
      labels,
      datasets: [{
        label: "Quantidade vendida",
        data,
        backgroundColor: "rgba(20,184,166,.8)",
        borderRadius: 8
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => ` ${ctx.raw}`
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { precision: 0 }
        }
      }
    }
  });
}

/* Eventos */
[de, ate].forEach(el => el.addEventListener("change", consultar));

consultar();
</script>

</body>
</html>
