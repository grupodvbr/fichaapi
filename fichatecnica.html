<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Ficha TÃ©cnica â€¢ DEBUG</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<style>
body{font-family:Inter;background:#f1f5f9;margin:0;padding:20px}
.container{display:grid;grid-template-columns:2fr 1fr;gap:20px;max-width:1400px;margin:auto}
.card{background:#fff;border-radius:20px;padding:24px}
h1{margin-top:0}
input{width:100%;padding:12px;border-radius:12px;border:1px solid #cbd5e1}
.item{padding:10px;border-radius:10px;background:#f8fafc;margin-top:6px;cursor:pointer}
.item:hover{background:#e2e8f0}
.badge{margin-top:10px;display:inline-block;padding:6px 14px;border-radius:999px;background:#e0f2fe;font-weight:800}
.log{background:#020617;color:#e5e7eb;border-radius:20px;padding:20px;height:80vh;overflow:auto;font-size:13px}
.log b{color:#38bdf8}
</style>
</head>

<body>

<div class="container">

<!-- APP -->
<div class="card">
  <h1>ðŸ“‹ Ficha TÃ©cnica (DEBUG)</h1>

  <label>Produto</label>
  <input id="buscaProduto" placeholder="Digite o nome do produto">
  <div id="listaProduto"></div>

  <div id="produtoBadge" class="badge" style="display:none"></div>

  <h3>PreÃ§o Venda</h3>
  <input id="precoVenda" readonly>

</div>

<!-- LOG -->
<div class="log" id="log">
  <b>ðŸ§  LOG EM TEMPO REAL</b><br><br>
</div>

</div>

<script>
const logBox = document.getElementById("log");
function log(msg, obj){
  const h = new Date().toLocaleTimeString();
  logBox.innerHTML += `<div>[${h}] <b>${msg}</b><pre>${JSON.stringify(obj,null,2)}</pre></div>`;
  logBox.scrollTop = logBox.scrollHeight;
}

let debounce=null;
let produto=null;

/* BUSCA */
buscaProduto.oninput=()=>{
  clearTimeout(debounce);
  const termo = buscaProduto.value.trim();
  if(termo.length<3) return;

  log("âŒ¨ï¸ Digitado no campo de produto",{termo});

  debounce=setTimeout(async()=>{
    const url=`/api/produtos-busca?q=${encodeURIComponent(termo)}`;
    log("ðŸ“¡ Chamando API de busca",{url});

    const r=await fetch(url);
    const j=await r.json();

    log("ðŸ“¦ Retorno da busca",j);

    listaProduto.innerHTML=j.items.map(p=>`
      <div class="item" onclick="selectProduto(${p.id},'${p.descricao.replace(/'/g,"")}')">
        ${p.descricao}
      </div>
    `).join("");
  },300);
};

/* SELEÃ‡ÃƒO */
async function selectProduto(id,nome){
  log("ðŸ–±ï¸ Produto selecionado",{id,nome});

  const url=`/api/produto-preco/${id}`;
  log("ðŸ“¡ Chamando API de preÃ§o",{url});

  const r=await fetch(url);
  const json=await r.json();

  log("ðŸ“¦ JSON bruto do preÃ§o",json);

  const p = Array.isArray(json) ? json[0] : json.items?.[0];

  if(!p){
    log("âŒ Nenhum preÃ§o encontrado",json);
    return;
  }

  const campos = {
    precoOferta1:p.precoOferta1,
    precoVenda1:p.precoVenda1,
    precoVenda2:p.precoVenda2,
    precoVenda3:p.precoVenda3
  };

  log("ðŸ”Ž Campos avaliados",campos);

  const preco =
    (Number(p.precoOferta1) > 0 && Number(p.precoOferta1)) ||
    Number(p.precoVenda1) ||
    Number(p.precoVenda2) ||
    Number(p.precoVenda3) ||
    0;

  log("ðŸ’° PreÃ§o final calculado",{precoFinal:preco});

  produto={id,nome,preco};

  produtoBadge.style.display="inline-block";
  produtoBadge.textContent=`${nome} â€¢ R$ ${preco.toFixed(2)}`;

  precoVenda.value=`R$ ${preco.toFixed(2)}`;
}
</script>

</body>
</html>
