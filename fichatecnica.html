<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Ficha TÃ©cnica â€¢ CMV Profissional</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  margin:0;
  padding:20px;
  background:#eef2ff;
  font-family:Inter,Arial,sans-serif;
}
.container{
  max-width:1100px;
  margin:auto;
  background:#fff;
  border-radius:24px;
  padding:30px;
  box-shadow:0 30px 60px rgba(0,0,0,.12);
}
label{font-weight:700;font-size:13px;margin-top:16px;display:block}
input,select,button{
  width:100%;
  padding:14px;
  border-radius:16px;
  border:1px solid #cbd5e1;
  margin-top:6px;
}
button{
  background:#2563eb;
  color:#fff;
  border:none;
  font-weight:800;
  cursor:pointer;
}
.lista .item{
  background:#f1f5f9;
  padding:12px;
  border-radius:12px;
  margin-top:6px;
  cursor:pointer;
}
.ing{
  display:flex;
  justify-content:space-between;
  background:#f8fafc;
  padding:10px 14px;
  border-radius:12px;
  margin-top:6px;
}
.preview{
  width:100%;
  max-height:220px;
  object-fit:cover;
  border-radius:18px;
  margin-top:10px;
}
.overlay{
  position:fixed;
  inset:0;
  background:rgba(255,255,255,.7);
  display:none;
  align-items:center;
  justify-content:center;
  font-weight:800;
  font-size:18px;
  z-index:999;
}
</style>
</head>

<body>

<div class="overlay" id="overlay">Salvandoâ€¦</div>

<div class="container">
<h1>ðŸ“‹ Ficha TÃ©cnica</h1>

<label>Produto</label>
<input id="buscaProduto">
<div id="listaProduto" class="lista"></div>

<label>Foto</label>
<input type="file" id="fotoProduto" accept="image/*">
<img id="previewFoto" class="preview" style="display:none">

<label>Ingrediente</label>
<input id="buscaIngrediente">
<div id="listaIngrediente" class="lista"></div>

<div style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr auto;gap:6px">
  <input id="qtd" type="number" step="0.001" placeholder="Qtd">
  <select id="unUso"><option>UN</option><option>KG</option><option>G</option></select>
  <input id="custo" readonly placeholder="Custo">
  <input id="rend" placeholder="Rend %">
  <button onclick="addIngrediente()">+</button>
</div>

<div id="listaIng"></div>

<label>PorÃ§Ãµes</label>
<input id="rendimentoFinal" value="1" type="number" oninput="render()">

<button onclick="salvar()" style="margin-top:20px">SALVAR</button>
</div>

<script>
const sb = supabase.createClient(
  "https://dsngsuetvucxeztbgbtb.supabase.co",
  "sb_publishable_rN6fZXNxnjgwnbXTPXEP5A_7n5Ty9Cp"
);

// AUTH ANÃ”NIMO
sb.auth.signInAnonymously();

const overlay = document.getElementById("overlay");
const show = ()=>overlay.style.display="flex";
const hide = ()=>overlay.style.display="none";

let produto=null, ingrediente=null, ingredientes=[];

// FOTO
fotoProduto.onchange=()=>{
  const f=fotoProduto.files[0];
  if(!f)return;
  previewFoto.src=URL.createObjectURL(f);
  previewFoto.style.display="block";
};

// BUSCA PRODUTO
buscaProduto.oninput=async()=>{
  if(buscaProduto.value.length<3)return;
  const r=await fetch(`/api/produtos-busca?q=${buscaProduto.value}`);
  const j=await r.json();
  listaProduto.innerHTML=j.items.map(p=>`
    <div class="item" onclick="selectProduto(${p.id},'${p.descricao.replace(/'/g,"")}')">
      ${p.descricao}
    </div>`).join("");
};

async function selectProduto(id,nome){
  const r=await fetch(`/api/produto-preco/${id}`);
  const j=await r.json();
  const p=j.items?.[0]||j[0]||{};
  produto={id,nome,preco:Number(p.precoVenda1||0)};
  listaProduto.innerHTML=`<b>${nome}</b>`;
}

// BUSCA INGREDIENTE
buscaIngrediente.oninput=async()=>{
  if(buscaIngrediente.value.length<3)return;
  const r=await fetch(`/api/produtos-busca?q=${buscaIngrediente.value}`);
  const j=await r.json();
  listaIngrediente.innerHTML=j.items.map(p=>`
    <div class="item" onclick="selectIng(${p.id},'${p.descricao.replace(/'/g,"")}')">
      ${p.descricao}
    </div>`).join("");
};

async function selectIng(id,nome){
  const r=await fetch(`/api/produto-preco/${id}`);
  const j=await r.json();
  const p=j.items?.[0]||j[0]||{};
  ingrediente={nome,custo:Number(p.precoMedioDeReposicao||p.custoProduto||0)};
  custo.value=ingrediente.custo.toFixed(4);
}

// ADD
function addIngrediente(){
  if(!ingrediente||!qtd.value)return;
  const total=qtd.value*ingrediente.custo*((rend.value||100)/100);
  ingredientes.push({nome:ingrediente.nome,quantidade:qtd.value,un:unUso.value,total});
  ingrediente=null;
  qtd.value="";rend.value="";
  render();
}

function render(){
  listaIng.innerHTML=ingredientes.map(i=>`
    <div class="ing"><span>${i.nome}</span><b>R$ ${i.total.toFixed(2)}</b></div>
  `).join("");
}

// SALVAR
async function salvar(){
  if(!produto||!ingredientes.length)return alert("Dados incompletos");
  show();

  let fotoUrl=null;
  if(fotoProduto.files[0]){
    const file=fotoProduto.files[0];
    const safe=file.name.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-zA-Z0-9._-]/g,"_");
    const path=`fichas/${Date.now()}-${safe}`;

    const {error}=await sb.storage.from("buffet").upload(path,file,{
      contentType:file.type,
      upsert:false
    });
    if(error){hide();alert(error.message);return;}
    fotoUrl=sb.storage.from("buffet").getPublicUrl(path).data.publicUrl;
  }

  const cmv=ingredientes.reduce((s,i)=>s+i.total,0);
  const por=rendimentoFinal.value||1;

  const {data,error}=await sb.from("buffet").insert({
    produto_id:produto.id,
    nome:produto.nome,
    preco_venda:produto.preco,
    custo_total:cmv,
    custo_unitario:cmv/por,
    rendimento:por,
    foto_url:fotoUrl
  }).select().single();

  if(error){hide();alert(error.message);return;}

  for(const i of ingredientes){
    await sb.from("buffet_itens").insert({
      buffet_id:data.id,
      nome:i.nome,
      unidade_uso:i.un,
      quantidade:i.quantidade,
      custo_unitario:0,
      custo_calculado:i.total
    });
  }

  hide();
  alert("SALVO");
  location.reload();
}
</script>
</body>
</html>
