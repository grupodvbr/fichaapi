<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>PAINEL DE INGREDIENTES • CMV</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --primary:#14b8a6;
  --primary-dark:#0f766e;
  --primary-soft:#e6fffa;
  --bg:#0b1220;
  --panel:#0f172a;
  --card:#0b1220;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --border:rgba(148,163,184,.18);
  --ring:rgba(20,184,166,.35);
  --radius-xl:26px;
  --radius-lg:18px;
  --radius-md:14px;
  --shadow-soft:0 10px 30px rgba(0,0,0,.35);
  --shadow-strong:0 30px 80px rgba(0,0,0,.55);
}

/* RESET */
*{box-sizing:border-box}
html,body{
  margin:0;
  width:100%;
  height:100%;
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  background:
    radial-gradient(1200px 600px at 10% -10%, rgba(20,184,166,.08), transparent 60%),
    radial-gradient(900px 500px at 110% 10%, rgba(20,184,166,.06), transparent 55%),
    var(--bg);
  color:var(--text);
}

/* APP */
.app{
  display:grid;
  grid-template-columns:320px 1fr;
  height:100vh;
}

/* SIDEBAR */
.sidebar{
  background:
    linear-gradient(180deg, rgba(15,23,42,.9), rgba(11,18,32,.95));
  border-right:1px solid var(--border);
  padding:22px 18px 18px;
  display:flex;
  flex-direction:column;
  gap:14px;
  height:100vh;
}

.sidebar h2{
  margin:6px 8px 10px;
  font-size:18px;
  font-weight:900;
  letter-spacing:.06em;
  color:#e6fffa;
}

.sidebar input{
  background:#0b1220;
  color:var(--text);
  padding:14px;
  border-radius:999px;
  border:1px solid var(--border);
  outline:none;
  text-transform:uppercase;
}
.sidebar input::placeholder{color:var(--muted)}
.sidebar input:focus{
  border-color:var(--primary);
  box-shadow:0 0 0 4px var(--ring);
}

/* LISTA */
.lista{
  margin-top:6px;
  padding:10px;
  flex:1;
  overflow-y:auto;
  border-radius:18px;
  background:
    linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.01));
  border:1px solid var(--border);
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.02);
}
.lista::-webkit-scrollbar{width:8px}
.lista::-webkit-scrollbar-thumb{
  background:rgba(148,163,184,.25);
  border-radius:999px;
}

.item{
  padding:12px 14px;
  border-radius:14px;
  margin-bottom:6px;
  cursor:pointer;
  font-weight:800;
  letter-spacing:.03em;
  color:#c7d2fe;
  background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));
  border:1px solid var(--border);
  transition:.15s ease;
}
.item:hover{
  transform:translateY(-1px);
  border-color:rgba(20,184,166,.6);
  box-shadow:0 8px 24px rgba(20,184,166,.15);
}
.item.active{
  background:linear-gradient(135deg, rgba(20,184,166,.18), rgba(20,184,166,.05));
  border-color:rgba(20,184,166,.75);
  box-shadow:0 10px 26px rgba(20,184,166,.25);
  color:#e6fffa;
}

/* BOTÃO NOVO */
.new{
  margin-top:auto;
  background:linear-gradient(135deg,var(--primary),var(--primary-dark));
  border:none;
  border-radius:999px;
  padding:14px 18px;
  font-weight:900;
  letter-spacing:.1em;
  color:#042f2e;
  cursor:pointer;
  box-shadow:0 16px 44px rgba(20,184,166,.45);
  transition:.2s ease;
}
.new:hover{
  transform:translateY(-1px) scale(1.01);
  box-shadow:0 20px 64px rgba(20,184,166,.65);
}

/* MAIN */
.main{
  padding:28px 28px 36px;
  overflow:auto;
}
.main::-webkit-scrollbar{width:10px}
.main::-webkit-scrollbar-thumb{
  background:rgba(148,163,184,.25);
  border-radius:999px;
}

/* CARD */
.card{
  max-width:1100px;
  margin:0 auto;
  background:
    radial-gradient(120% 120% at 10% 0%, rgba(255,255,255,.05), transparent 40%),
    linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02)),
    var(--panel);
  border-radius:28px;
  padding:32px;
  box-shadow:0 30px 80px rgba(0,0,0,.65);
  border:1px solid var(--border);
}

.card h1{
  margin:0 0 12px;
  font-size:28px;
  font-weight:900;
  letter-spacing:.06em;
}
.card h3{
  margin:10px 0 4px;
  font-weight:900;
  color:#e6fffa;
}

/* SEÇÕES */
.section{
  margin-top:26px;
  padding-top:18px;
  border-top:1px dashed var(--border);
}

/* FORM GRID */
.form-grid{
  display:grid;
  grid-template-columns: repeat(3, minmax(0,1fr));
  gap:16px 14px;
  margin-top:14px;
}

.field{
  display:flex;
  flex-direction:column;
}

.field.full{
  grid-column:1 / -1;
}

.form-grid h3{
  grid-column:1 / -1;
}

/* INPUTS */
input, select{
  width:100%;
  padding:14px 16px;
  border-radius:14px;
  border:1px solid var(--border);
  margin-top:6px;
  background:
    linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)),
    #020617;
  color:var(--text);
  text-transform:uppercase;
  outline:none;
  transition:.15s ease;
}
input::placeholder{color:var(--muted)}
input:focus, select:focus{
  border-color:var(--primary);
  box-shadow:0 0 0 4px var(--ring);
}

.field label{
  font-size:12px;
  font-weight:800;
  letter-spacing:.08em;
  color:#cbd5e1;
}

/* BOTÃO SALVAR */
button{
  margin-top:26px;
  border:none;
  border-radius:999px;
  background:linear-gradient(135deg,var(--primary),var(--primary-dark));
  color:#042f2e;
  font-weight:900;
  letter-spacing:.12em;
  padding:16px 22px;
  box-shadow:0 16px 44px rgba(20,184,166,.45);
  cursor:pointer;
  transition:.2s ease;
}
button:hover{
  transform:translateY(-1px) scale(1.01);
  box-shadow:0 20px 64px rgba(20,184,166,.65);
}

/* RESPONSIVO */
@media(max-width:980px){
  .app{grid-template-columns:1fr}
  .sidebar{
    position:sticky;
    top:0;
    height:auto;
    border-right:none;
    border-bottom:1px solid var(--border);
    border-radius:0 0 22px 22px;
  }
}
@media(max-width:900px){
  .form-grid{grid-template-columns:repeat(2,1fr)}
}
@media(max-width:520px){
  .form-grid{grid-template-columns:1fr}
}
</style>
</head>

<body>

<div class="app">

<!-- SIDEBAR -->
<div class="sidebar">
  <h2>INGREDIENTES</h2>
  <input id="busca" placeholder="BUSCAR...">
  <div id="lista" class="lista"></div>
  <button class="new" onclick="novo()">+ NOVO INGREDIENTE</button>
</div>

<!-- MAIN -->
<div class="main">
  <div class="card">

    <h1 id="titulo">NOVO INGREDIENTE</h1>
<div class="section form-grid">

  <div class="field full">
    <label>NOME</label>
    <input id="nome">
  </div>

  <div class="field full">
    <label>DESCRIÇÃO</label>
    <input id="descricao">
  </div>

  <div class="field">
    <label>UNIDADE</label>
    <select id="unidade">
      <option>UN</option><option>KG</option><option>G</option><option>L</option><option>ML</option>
    </select>
  </div>

</div>

<div class="section form-grid">

  <div class="field">
    <label>VALOR</label>
    <input id="valor">
  </div>

  <div class="field">
    <label>RENDIMENTO (%)</label>
    <input id="rendimento" value="100">
  </div>

</div>

   <div class="section form-grid">

  <h3>INFORMAÇÃO NUTRICIONAL (por 100g ou 100ml)</h3>

  <div class="field">
    <label>VALOR ENERGÉTICO (kcal)</label>
    <input id="energia_kcal" type="number">
  </div>

  <div class="field">
    <label>CARBOIDRATOS (g)</label>
    <input id="carboidratos" type="number">
  </div>

  <div class="field">
    <label>AÇÚCARES TOTAIS (g)</label>
    <input id="acucares_totais" type="number">
  </div>

  <div class="field">
    <label>AÇÚCARES ADICIONADOS (g)</label>
    <input id="acucares_adicionados" type="number">
  </div>

  <div class="field">
    <label>PROTEÍNAS (g)</label>
    <input id="proteinas" type="number">
  </div>

  <div class="field">
    <label>GORDURAS TOTAIS (g)</label>
    <input id="gorduras_totais" type="number">
  </div>

  <div class="field">
    <label>GORDURAS SATURADAS (g)</label>
    <input id="gorduras_saturadas" type="number">
  </div>

  <div class="field">
    <label>GORDURAS TRANS (g)</label>
    <input id="gorduras_trans" type="number">
  </div>

  <div class="field">
    <label>FIBRA ALIMENTAR (g)</label>
    <input id="fibra_alimentar" type="number">
  </div>

  <div class="field">
    <label>SÓDIO (mg)</label>
    <input id="sodio_mg" type="number">
  </div>

</div>
    <button onclick="salvar()">SALVAR INGREDIENTE</button>

  </div>
</div>

</div>

<div id="toast" class="toast">SALVO COM SUCESSO</div>

<script>
const sb = supabase.createClient(
  "https://dxkszikemntfusfyrzos.supabase.co",
  "sb_publishable_NNFvdfSXgOdGGVcSbphbjQ_brC3_9ed"
);

let atual=null;

function toast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),2500);
}

document.addEventListener("input",e=>{
  if(e.target.tagName==="INPUT") e.target.value=e.target.value.toUpperCase();
});

function moeda(el){
  el.oninput=()=>{
    let v=el.value.replace(/\D/g,"");
    el.value="R$ "+(v/100).toFixed(2).replace(".",",");
  }
}
window.addEventListener("DOMContentLoaded", ()=>{
  moeda(valor);
});
let pagina = 0;
const LIMITE = 20;
let carregando = false;
let fim = false;

async function carregar(reset=false){
  if(carregando || fim) return;
  carregando = true;

  if(reset){
    pagina = 0;
    fim = false;
    lista.innerHTML = "";
  }

  const { data } = await sb
    .from("produtos")
    .select("*")
    .order("id", { ascending: false })  // últimos primeiro
    .range(pagina*LIMITE, (pagina+1)*LIMITE - 1);

  if(!data || data.length === 0){
    fim = true;
    carregando = false;
    return;
  }

  lista.insertAdjacentHTML("beforeend",
    data.map(i=>`
      <div class="item ${atual?.id===i.id?'active':''}" onclick="editar('${i.id}')">
        ${i.nome}
      </div>
    `).join("")
  );

  pagina++;
  carregando = false;
}

carregar(true);

lista.addEventListener("scroll", ()=>{
  const pertoDoFim =
    lista.scrollTop + lista.clientHeight
    >= lista.scrollHeight - 40;

  if(pertoDoFim){
    carregar();
  }
});

busca.oninput = async ()=>{
  const q = busca.value.trim().toLowerCase();
  if(!q){
    carregar(true);
    return;
  }

  const { data } = await sb
    .from("produtos")
    .select("*")
    .ilike("nome", `%${q}%`);

  lista.innerHTML = (data||[]).map(i=>`
    <div class="item" onclick="editar('${i.id}')">${i.nome}</div>
  `).join("");
};

async function editar(id){
  const {data}=await sb.from("produtos").select("*").eq("id",id).single();
  atual=data;
  titulo.textContent="EDITAR INGREDIENTE";

  Object.keys(data).forEach(k=>{
    if(document.getElementById(k)) document.getElementById(k).value=data[k]||"";
  });

  valor.value="R$ "+Number(data.valor).toFixed(2).replace(".",",");
}

function novo(){
  atual=null;
  titulo.textContent="NOVO INGREDIENTE";
  document.querySelectorAll("input").forEach(i=>i.value="");
  rendimento.value=100;
}

async function salvar(){
  const payload={
    nome:nome.value,
    descricao:descricao.value,
    unidade_medida:unidade.value,
    valor:Number(valor.value.replace(/\D/g,""))/100,
    rendimento_percentual:Number(rendimento.value),

    energia_kcal:+energia_kcal.value||0,
    carboidratos:+carboidratos.value||0,
    acucares_totais:+acucares_totais.value||0,
    acucares_adicionados:+acucares_adicionados.value||0,
    proteinas:+proteinas.value||0,
    gorduras_totais:+gorduras_totais.value||0,
    gorduras_saturadas:+gorduras_saturadas.value||0,
    gorduras_trans:+gorduras_trans.value||0,
    fibra_alimentar:+fibra_alimentar.value||0,
    sodio_mg:+sodio_mg.value||0
  };

  if(atual){
    await sb.from("produtos").update(payload).eq("id",atual.id);
  }else{
    const {data}=await sb.from("produtos").insert(payload).select().single();
    atual=data;
  }

  toast("SALVO COM SUCESSO");
carregar(true);}
</script>

</body>
</html>
