<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>PAINEL DE INGREDIENTES â€¢ CMV</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --primary:#14b8a6;
  --primary-dark:#0f766e;
  --bg:#f1f5f9;
  --card:#ffffff;
  --muted:#64748b;
}

*{box-sizing:border-box}

body{
  margin:0;
  background:var(--bg);
  font-family:Inter,sans-serif;
}

.app{
  display:grid;
  grid-template-columns:320px 1fr;
  height:100vh;
}

/* SIDEBAR */
.sidebar{
  background:#fff;
  padding:20px;
  border-right:1px solid #e5e7eb;
  display:flex;
  flex-direction:column;
}

.sidebar h2{
  font-size:18px;
  margin-bottom:12px;
}

.sidebar input{
  padding:12px;
  border-radius:14px;
  border:1px solid #cbd5e1;
  text-transform:uppercase;
}

.lista{
  margin-top:12px;
  overflow:auto;
  flex:1;
}

.item{
  padding:12px;
  border-radius:12px;
  margin-bottom:6px;
  cursor:pointer;
  font-weight:800;
  text-transform:uppercase;
}

.item:hover{background:#f1f5f9}
.item.active{background:#e0f2fe}

.new{
  margin-top:12px;
  background:#e5e7eb;
  border:none;
  border-radius:14px;
  padding:12px;
  font-weight:800;
  cursor:pointer;
}

/* MAIN */
.main{
  padding:28px;
}

.card{
  background:var(--card);
  border-radius:24px;
  padding:28px;
  box-shadow:0 20px 40px rgba(0,0,0,.08);
  max-width:900px;
}

label{
  display:block;
  font-size:13px;
  font-weight:800;
  margin-top:14px;
}

input,select,button{
  width:100%;
  padding:14px 16px;
  border-radius:16px;
  border:1px solid #cbd5e1;
  margin-top:6px;
  text-transform:uppercase;
}

button{
  background:linear-gradient(180deg,var(--primary),var(--primary-dark));
  color:#fff;
  font-weight:800;
  border:none;
  cursor:pointer;
  margin-top:20px;
}

.grid{
  display:grid;
  grid-template-columns:1fr 1fr 1fr auto;
  gap:10px;
}

.var{
  background:#f8fafc;
  padding:14px;
  border-radius:14px;
  margin-top:8px;
  display:flex;
  justify-content:space-between;
  font-weight:800;
  text-transform:uppercase;
}

/* TOAST */
.toast{
  position:fixed;
  bottom:20px;
  right:20px;
  background:#22c55e;
  color:#fff;
  padding:14px 20px;
  border-radius:14px;
  font-weight:800;
  opacity:0;
  transform:translateY(10px);
  transition:.3s;
  pointer-events:none;
}

.toast.show{
  opacity:1;
  transform:translateY(0);
}
</style>
</head>

<body>

<div class="app">

<!-- SIDEBAR -->
<div class="sidebar">
  <h2>INGREDIENTES</h2>
  <input id="busca" placeholder="BUSCAR...">
  <div id="lista" class="lista"></div>
  <button class="new" onclick="novo()">+ NOVO INGREDIENTE</button>
</div>

<!-- MAIN -->
<div class="main">
  <div class="card">
    <h1 id="titulo">NOVO INGREDIENTE</h1>

    <label>NOME</label>
    <input id="nome">

    <label>DESCRIÃ‡ÃƒO</label>
    <input id="descricao">

    <label>UNIDADE</label>
    <select id="unidade">
      <option>UN</option><option>KG</option><option>G</option><option>L</option><option>ML</option>
    </select>

    <label>VALOR</label>
    <input id="valor">

    <label>RENDIMENTO (%)</label>
    <input id="rendimento" value="100">

    <button onclick="salvar()">SALVAR INGREDIENTE</button>

    <hr style="margin:30px 0">

    <h3>VARIAÃ‡Ã•ES</h3>

    <div class="grid">
      <select id="vUn">
        <option>UN</option><option>KG</option><option>G</option><option>L</option><option>ML</option>
      </select>
      <input id="vValor" placeholder="R$ 0,00">
      <input id="vRend" value="100">
      <button onclick="addVariacao()">+</button>
    </div>

    <div id="vars"></div>
  </div>
</div>

</div>

<div id="toast" class="toast">SALVO COM SUCESSO</div>

<script>
const sb = supabase.createClient(
  "https://dxkszikemntfusfyrzos.supabase.co",
  "sb_publishable_NNFvdfSXgOdGGVcSbphbjQ_brC3_9ed"
);

let atual=null;

/* TOAST */
function toast(msg){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),2500);
}

/* FORÃ‡A MAIÃšSCULA */
document.addEventListener("input",e=>{
  if(e.target.tagName==="INPUT") e.target.value=e.target.value.toUpperCase();
});

/* MÃSCARAS */
function moeda(el){
  el.oninput=()=>{
    let v=el.value.replace(/\D/g,"");
    el.value="R$ "+(v/100).toFixed(2).replace(".",",");
  }
}
function numero(el){el.oninput=()=>el.value=el.value.replace(/\D/g,"")}

moeda(valor); moeda(vValor);
numero(rendimento); numero(vRend);

/* LISTAR */
async function carregar(){
  const {data}=await sb.from("produtos").select("*").order("nome");
  renderLista(data||[]);
}
carregar();

function renderLista(items){
  lista.innerHTML=items.map(i=>`
    <div class="item ${atual?.id===i.id?'active':''}" onclick="editar('${i.id}')">
      ${i.nome}
    </div>`).join("");
}

/* BUSCA */
busca.oninput=async()=>{
  const q=busca.value.toLowerCase();
  const {data}=await sb.from("produtos").select("*");
  renderLista(data.filter(p=>p.nome.toLowerCase().includes(q)));
};

/* EDITAR */
async function editar(id){
  const {data}=await sb.from("produtos").select("*").eq("id",id).single();
  atual=data;

  titulo.textContent="EDITAR INGREDIENTE";
  nome.value=data.nome;
  descricao.value=data.descricao||"";
  unidade.value=data.unidade_medida;
  valor.value="R$ "+Number(data.valor).toFixed(2).replace(".",",");
  rendimento.value=data.rendimento_percentual;

  await carregarVariacoes(id);
}


/* NOVO */
function novo(){
  atual=null;
  titulo.textContent="NOVO INGREDIENTE";
  nome.value=descricao.value=valor.value="";
  rendimento.value=100;
  vars.innerHTML="";
}

/* SALVAR */
async function salvar(){
  const payload={
    nome:nome.value,
    descricao:descricao.value,
    unidade_medida:unidade.value,
    valor:Number(valor.value.replace(/\D/g,""))/100,
    rendimento_percentual:Number(rendimento.value)
  };

  if(atual){
    await sb.from("produtos").update(payload).eq("id",atual.id);
  }else{
    const {data}=await sb.from("produtos").insert(payload).select().single();
    atual=data;
  }

  toast("SALVO COM SUCESSO");
  carregar();
}

/* VARIAÃ‡Ã•ES */
async function addVariacao(){
  if(!atual) return toast("SALVE O INGREDIENTE PRIMEIRO");

  const unidadeMedida = vUn.value;
  const valorNum = Number(vValor.value.replace(/\D/g,""))/100;
  const rendNum = Number(vRend.value);

  // ðŸ”Ž verifica se jÃ¡ existe
  const { data:existe } = await sb
    .from("produto_variacoes")
    .select("id")
    .eq("produto_id", atual.id)
    .eq("unidade_medida", unidadeMedida)
    .single();

  if(existe){
    // ðŸ” UPDATE
    await sb
      .from("produto_variacoes")
      .update({
        valor: valorNum,
        rendimento_percentual: rendNum
      })
      .eq("id", existe.id);

    toast("VARIAÃ‡ÃƒO ATUALIZADA");
  }else{
    // âž• INSERT
    await sb.from("produto_variacoes").insert({
      produto_id: atual.id,
      unidade_medida: unidadeMedida,
      valor: valorNum,
      rendimento_percentual: rendNum
    });

    toast("VARIAÃ‡ÃƒO CRIADA");
  }

  await carregarVariacoes(atual.id);
}


function renderVars(vs){
  vars.innerHTML=vs.map(v=>`
    <div class="var">
      ${v.unidade_medida} â€¢ R$ ${Number(v.valor).toFixed(2)} â€¢ ${v.rendimento_percentual}%
    </div>`).join("");
}async function carregarVariacoes(produtoId){
  const { data, error } = await sb
    .from("produto_variacoes")
    .select("*")
    .eq("produto_id", produtoId)
    .order("unidade_medida");

  if(error){
    toast("ERRO AO CARREGAR VARIAÃ‡Ã•ES");
    return;
  }

  renderVars(data || []);
}

</script>

</body>
</html>
