<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Ingredientes ‚Ä¢ Base de Produtos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
:root{
  --primary:#2563eb;
  --primary-dark:#1e40af;
  --bg:#f4f6fb;
  --card:#ffffff;
  --text:#0f172a;
  --muted:#64748b;
  --border:#e5e7eb;   /* linhas fininhas */
  --radius:22px;
  --shadow:0 18px 40px rgba(2,6,23,.08);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:Inter,sans-serif;
  background:
    radial-gradient(1200px 500px at 10% -10%, #eef2ff 0%, transparent 60%),
    radial-gradient(1200px 500px at 110% 10%, #ecfeff 0%, transparent 60%),
    var(--bg);
  color:var(--text);
  overflow:hidden;
}

/* ===== HEADER FIXO ===== */
.header{
  position:fixed; top:0; left:0; right:0; z-index:10;
  backdrop-filter: blur(10px);
  background:rgba(244,246,251,.96);
  border-bottom:1px solid var(--border);
}
.header-inner{
  max-width:1400px; margin:auto; padding:14px 18px 12px;
  display:flex; flex-wrap:wrap; gap:10px; align-items:center;
}
.header h1{margin:0;font-size:22px;font-weight:900; letter-spacing:-.02em}
.sub{font-size:12px; color:var(--muted); font-weight:600}

/* ===== CONTROLES ===== */
.controls{
  width:100%;
  display:grid;
  grid-template-columns:2fr 1fr auto;
  gap:10px;
}
.controls input{
  height:42px; border-radius:999px; border:1px solid var(--border);
  padding:0 16px; font-weight:800; background:#fff;
}
.controls input:focus{
  outline:none; border-color:var(--primary);
  box-shadow:0 0 0 3px rgba(37,99,235,.2);
}
.btn{
  height:42px; padding:0 20px; border-radius:999px; border:none;
  cursor:pointer; font-weight:900; letter-spacing:.08em; color:#fff;
  background:linear-gradient(135deg,var(--primary),var(--primary-dark));
  box-shadow:0 10px 24px rgba(37,99,235,.35);
}

/* ===== CONTE√öDO COM SCROLL ===== */
.main{
  position:fixed; top:92px; left:0; right:0; bottom:0;
  overflow:auto; padding:18px;
}

.table-wrap{
  background:var(--card);
  border-radius:22px;
  border:1px solid var(--border);
  box-shadow:var(--shadow);
  overflow:auto;
}

table{
  width:100%;
  border-collapse:collapse;
  min-width:1100px;
  font-size:13px;
}

th,td{
  padding:12px 10px;
  border-bottom:1px solid var(--border); /* linhas fininhas */
  text-align:left;
}

th{
  background:#f1f5f9;
  font-weight:900;
  position:sticky;
  top:0;
  z-index:2;
}

tbody tr:hover{ background:#f8fafc }

/* ===== INPUTS NA TABELA ===== */
td input, td select, td textarea{
  width:100%;
  border:1px solid var(--border);
  border-radius:10px;
  padding:8px 10px;
  font-weight:700;
  font-family:Inter,sans-serif;
  background:#fff;
}
td input:focus, td select:focus, td textarea:focus{
  outline:none; border-color:var(--primary);
  box-shadow:0 0 0 2px rgba(37,99,235,.15);
}
td textarea{ resize:vertical; min-height:34px }

.readonly{
  background:#f1f5f9;
  color:#64748b;
  cursor:not-allowed;
}

@media(max-width:900px){
  .controls{ grid-template-columns:1fr; }
  table{ min-width:900px }
}
</style>
</head>

<body>
  <div class="header">
    <div class="header-inner">
      <div>
        <h1>üßæ Ingredientes ‚Ä¢ Base de Produtos</h1>
        <div class="sub">Edi√ß√£o de custos e rendimento ‚Ä¢ Exporta√ß√£o para Excel</div>
      </div>

      <div class="controls">
        <input id="busca" placeholder="Buscar ingrediente...">
        <button class="btn" onclick="exportarExcel()">üì• EXPORTAR EXCEL</button>
      </div>
    </div>
  </div>

  <div class="main">
    <div class="table-wrap">
      <table id="tabela">
        <thead>
          <tr>
            <th>Nome</th>
            <th>Descri√ß√£o</th>
            <th>Unidade</th>
            <th>Custo unit√°rio (R$)</th>
            <th>Rendimento %</th>
            <th>C√≥digo do varejo</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

<script>
const sb = supabase.createClient(
  "https://dxkszikemntfusfyrzos.supabase.co",
  "sb_publishable_NNFvdfSXgOdGGVcSbphbjQ_brC3_9ed"
);

let produtos = [];

async function carregar(){
  const { data, error } = await sb.from("produtos").select("*").order("nome");
  if(error){ alert("Erro ao carregar produtos: " + error.message); return; }
  produtos = data || [];
  render();
}

function render(){
  const tbody = document.querySelector("#tabela tbody");
  tbody.innerHTML = "";
  const termo = (document.getElementById("busca").value || "").toLowerCase().trim();

  produtos
    .filter(p => !termo || (p.nome||"").toLowerCase().includes(termo))
    .forEach(p=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input value="${p.nome||""}" onchange="salvar('${p.id}','nome',this.value)"></td>
        <td><textarea onchange="salvar('${p.id}','descricao',this.value)">${p.descricao||""}</textarea></td>
        <td>
          <select onchange="salvar('${p.id}','unidade_medida',this.value)">
            ${["KG","G","L","ML","UN"].map(u =>
              `<option value="${u}" ${p.unidade_medida===u?'selected':''}>${u}</option>`
            ).join("")}
          </select>
        </td>
        <td><input type="number" step="0.0001" value="${Number(p.valor||0)}"
              onchange="salvar('${p.id}','valor',this.value)"></td>
        <td><input type="number" step="0.01" value="${Number(p.rendimento_percentual||100)}"
              onchange="salvar('${p.id}','rendimento_percentual',this.value)"></td>
        <td><input class="readonly" readonly value="${p.codigo_varejo || '-'}"></td>
      `;
      tbody.appendChild(tr);
    });
}

async function salvar(id, campo, valor){
  const obj = {}; obj[campo] = valor;
  const { error } = await sb.from("produtos").update(obj).eq("id", id);
  if(error) alert("Erro ao salvar: " + error.message);
}

function exportarExcel(){
  const termo = (document.getElementById("busca").value || "").toLowerCase().trim();
  const filtrados = produtos.filter(p =>
    !termo || (p.nome||"").toLowerCase().includes(termo)
  );

  const planilha = filtrados.map(p=>({
    Nome: p.nome,
    Descri√ß√£o: p.descricao,
    Unidade: p.unidade_medida,
    "Custo Unit√°rio": Number(p.valor||0),
    "Rendimento %": Number(p.rendimento_percentual||100),
    "C√≥digo do Varejo": p.codigo_varejo || ""
  }));

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(planilha), "Ingredientes");
  XLSX.writeFile(wb, `ingredientes_${new Date().toISOString().slice(0,10)}.xlsx`);
}

document.getElementById("busca").oninput = render;

carregar();
</script>
</body>
</html>
